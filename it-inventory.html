<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>it-inventory‚Äã‚Äå‚Äã‚Äã‚Äå‚Äå‚Äã‚Äã‚Äç‚Äã‚Äå‚Äã‚Äã‚Äã‚Äã‚Äå‚Äå‚Äç‚Äã‚Äå‚Äã‚Äå‚Äã‚Äå‚Äå‚Äå</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #090d13;
      --panel: #0e1620;
      --card: #121e2d;
      --input-bg: #0a1118;
      --cyan: #00e5ff;
      --cyan-dim: #00a8bf;
      --amber: #ffaa00;
      --green: #00ff88;
      --red: #ff3355;
      --purple: #a855f7;
      --ewaste: #a855f7;
      --border: #1a3040;
      --border-glow: rgba(0, 229, 255, 0.25);
      --text: #cdd9e5;
      --text-bright: #f0faff;
      --text-dim: #4a6070;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Rajdhani', sans-serif;
      --scanline-opacity: 0.025;
      --shadow-glow: rgba(0, 229, 255, 0.08);
      --toggle-track: #1a3040;
      --toggle-thumb: #00e5ff;
    }

    [data-theme="light"] {
      --bg: #d4dce6;
      --panel: #c4cdd9;
      --card: #dce3ec;
      --input-bg: #ccd4de;
      --cyan: #0077aa;
      --cyan-dim: #005f8a;
      --amber: #c47700;
      --green: #007a44;
      --red: #cc1133;
      --purple: #7c3aed;
      --ewaste: #7c3aed;
      --border: #aabacb;
      --border-glow: rgba(0, 119, 170, 0.25);
      --text: #1e3347;
      --text-bright: #0a1a28;
      --text-dim: #6a8498;
      --scanline-opacity: 0;
      --shadow-glow: rgba(0, 119, 170, 0.08);
      --toggle-track: #aabacb;
      --toggle-thumb: #0077aa;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 5px 12px 5px 8px;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 1px;
      color: var(--text);
      transition: all .2s;
      white-space: nowrap;
      text-transform: uppercase;
    }

    .theme-toggle:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .toggle-track {
      width: 32px;
      height: 18px;
      background: var(--toggle-track);
      border-radius: 9px;
      position: relative;
      transition: background .3s;
      flex-shrink: 0;
      border: 1px solid var(--border);
    }

    .toggle-thumb {
      width: 12px;
      height: 12px;
      background: var(--toggle-thumb);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform .3s, background .3s;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    [data-theme="light"] .toggle-thumb {
      transform: translateX(14px);
    }

    .toggle-icon {
      font-size: 13px;
      line-height: 1;
    }

    [data-theme="light"] body::after {
      opacity: 0;
    }

    [data-theme="light"] .login-bg-grid {
      background-image: linear-gradient(rgba(0, 119, 170, 0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 119, 170, 0.06) 1px, transparent 1px);
    }

    [data-theme="light"] .login-bg-grid::before {
      background: radial-gradient(ellipse at 50% 50%, rgba(0, 119, 170, 0.05) 0%, transparent 70%);
    }

    [data-theme="light"] .stat-card .val {
      color: var(--cyan);
    }

    [data-theme="light"] .stat-card .val.green {
      color: var(--green);
    }

    [data-theme="light"] .stat-card .val.amber {
      color: var(--amber);
    }

    [data-theme="light"] .stat-card .val.ewaste {
      color: var(--ewaste);
    }

    [data-theme="light"] .rs-ok {
      background: rgba(0, 122, 68, 0.1);
      border-color: rgba(0, 122, 68, 0.3);
      color: var(--green);
    }

    [data-theme="light"] .rs-lookup {
      background: rgba(0, 119, 170, 0.08);
      border-color: rgba(0, 119, 170, 0.2);
      color: var(--cyan);
    }

    [data-theme="light"] .rs-manual {
      background: rgba(196, 119, 0, 0.1);
      border-color: rgba(196, 119, 0, 0.3);
      color: var(--amber);
    }

    [data-theme="light"] .sub-merged {
      background: rgba(0, 122, 68, 0.08);
      border-color: rgba(0, 122, 68, 0.25);
      color: var(--green);
    }

    [data-theme="light"] .mode-tab.active {
      background: rgba(0, 119, 170, 0.1);
      border-color: var(--cyan);
      color: var(--cyan);
    }

    [data-theme="light"] .toast {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    [data-theme="light"] .btn-primary {
      background: linear-gradient(135deg, #0077aa, #005f8a);
      color: #fff;
    }

    [data-theme="light"] .btn-amber {
      background: linear-gradient(135deg, #c47700, #9a5e00);
      color: #fff;
    }

    [data-theme="light"] .btn-success {
      background: linear-gradient(135deg, #007a44, #005f34);
      color: #fff;
    }

    [data-theme="light"] input[type="date"] {
      color-scheme: light;
    }

    [data-theme="light"] .del-all-bar {
      background: rgba(212, 220, 230, 0.97);
      border-top-color: var(--red);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.025) 2px, rgba(0, 0, 0, 0.025) 4px);
    }

    #loginScreen {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-bg-grid {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background-image: linear-gradient(rgba(0, 229, 255, 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 229, 255, 0.04) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .login-bg-grid::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 50%, rgba(0, 229, 255, 0.07) 0%, transparent 70%);
    }

    .login-box {
      position: relative;
      z-index: 2;
      background: var(--card);
      border: 1px solid var(--border-glow);
      border-radius: 6px;
      padding: 48px 40px;
      width: 380px;
      box-shadow: 0 0 60px rgba(0, 229, 255, 0.1);
      animation: loginFadeIn 0.5s ease;
    }

    @keyframes loginFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo-icon {
      width: 56px;
      height: 56px;
      border: 2px solid var(--cyan);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 24px;
      color: var(--cyan);
      font-family: var(--mono);
      animation: logoPulse 3s ease-in-out infinite;
    }

    @keyframes logoPulse {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(0, 229, 255, 0.3)
      }

      50% {
        box-shadow: 0 0 38px rgba(0, 229, 255, 0.55)
      }
    }

    .login-logo h1 {
      font-family: var(--sans);
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 3px;
      color: var(--text-bright);
      text-transform: uppercase;
    }

    .login-logo p {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--cyan-dim);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    .login-field {
      margin-bottom: 16px;
    }

    .login-field label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--cyan-dim);
      margin-bottom: 6px;
      font-family: var(--mono);
    }

    .login-field input {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-bright);
      padding: 10px 14px;
      font-family: var(--mono);
      font-size: 14px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    .login-field input:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
    }

    .login-error {
      background: rgba(255, 51, 85, 0.1);
      border: 1px solid rgba(255, 51, 85, 0.4);
      border-radius: 4px;
      padding: 8px 12px;
      color: var(--red);
      font-size: 12px;
      font-family: var(--mono);
      margin-bottom: 16px;
      display: none;
      text-align: center;
    }

    .btn-login {
      width: 100%;
      background: linear-gradient(135deg, var(--cyan), var(--cyan-dim));
      color: var(--bg);
      font-family: var(--sans);
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      border: none;
      border-radius: 4px;
      padding: 13px;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
      margin-top: 8px;
    }

    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 30px rgba(0, 229, 255, 0.45);
    }

    .login-hint {
      text-align: center;
      margin-top: 20px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .login-hint span {
      color: var(--amber);
    }

    .btn-change-pw {
      width: 100%;
      background: transparent;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, background 0.2s;
      margin-top: 10px;
    }
    .btn-change-pw:hover {
      border-color: var(--cyan-dim);
      color: var(--cyan);
      background: rgba(0, 229, 255, 0.04);
    }

    
    #cpPopup {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(3px);
    }
    #cpPopup.open {
      display: flex;
      animation: cpFadeIn 0.18s ease both;
    }
    @keyframes cpFadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .cp-box {
      background: var(--card);
      border: 1px solid rgba(0,229,255,0.25);
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 0 1px rgba(0,229,255,0.06), 0 32px 80px rgba(0,0,0,0.8), 0 0 50px rgba(0,229,255,0.07);
      animation: cpSlideUp 0.22s cubic-bezier(0.16,1,0.3,1) both;
      overflow: hidden;
    }
    @keyframes cpSlideUp {
      from { transform: translateY(20px) scale(0.97); opacity: 0; }
      to   { transform: translateY(0) scale(1);       opacity: 1; }
    }
    .cp-header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .cp-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-bright);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .cp-title::before {
      content: '';
      display: inline-block;
      width: 3px;
      height: 14px;
      background: var(--cyan);
      border-radius: 2px;
      flex-shrink: 0;
    }
    .cp-close {
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 18px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
      line-height: 1;
      transition: color 0.15s, background 0.15s;
    }
    .cp-close:hover { color: var(--text-bright); background: rgba(255,255,255,0.06); }
    .cp-body { padding: 24px 22px 20px; }
    .cp-section-label {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin: 18px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .cp-section-label::before,
    .cp-section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .cp-field { margin-bottom: 14px; }
    .cp-field label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--cyan-dim);
      font-family: var(--mono);
      margin-bottom: 6px;
    }
    .cp-field input {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-bright);
      padding: 10px 13px;
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .cp-field input:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(0,229,255,0.08);
    }
    .cp-field input.cp-invalid {
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(255,51,85,0.08);
      animation: cpShake 0.3s ease;
    }
    .cp-field input.cp-valid {
      border-color: var(--green);
    }
    @keyframes cpShake {
      0%,100% { transform: translateX(0); }
      25%      { transform: translateX(-5px); }
      75%      { transform: translateX(5px); }
    }
    .cp-strength { margin-top: 6px; display: flex; align-items: center; gap: 8px; }
    .cp-strength-track {
      flex: 1; height: 3px; background: var(--border); border-radius: 3px; overflow: hidden;
    }
    .cp-strength-fill {
      height: 100%; width: 0%; border-radius: 3px;
      transition: width 0.3s ease, background 0.3s ease;
    }
    .cp-strength-text {
      font-family: var(--mono); font-size: 9px; letter-spacing: 1px;
      text-transform: uppercase; min-width: 52px; text-align: right;
      color: var(--text-dim); transition: color 0.3s;
    }
    .cp-error {
      background: rgba(255,51,85,0.08);
      border: 1px solid rgba(255,51,85,0.3);
      border-radius: 4px;
      padding: 8px 11px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--red);
      margin-bottom: 14px;
      display: none;
      line-height: 1.4;
    }
    .cp-error.cp-show { display: block; }
    .cp-actions { display: flex; gap: 8px; margin-top: 4px; }
    .cp-btn-cancel {
      flex: 1;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-dim);
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 11px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .cp-btn-cancel:hover { border-color: var(--text-dim); color: var(--text); }
    .cp-btn-submit {
      flex: 2;
      background: linear-gradient(135deg, var(--cyan), var(--cyan-dim));
      border: none;
      border-radius: 4px;
      color: var(--bg);
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 11px;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.15s;
      box-shadow: 0 4px 18px rgba(0,229,255,0.25);
    }
    .cp-btn-submit:hover { transform: translateY(-1px); box-shadow: 0 8px 26px rgba(0,229,255,0.38); }
    .cp-btn-submit:active { transform: translateY(0); }
    
    .cp-success {
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 32px 22px 28px;
    }
    .cp-success.cp-show { display: flex; animation: cpFadeIn 0.3s ease; }
    .cp-success-icon {
      width: 56px; height: 56px;
      border: 2px solid var(--green);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px;
      color: var(--green);
      margin-bottom: 16px;
      box-shadow: 0 0 24px rgba(0,255,136,0.2);
      animation: cpPop 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes cpPop {
      from { transform: scale(0.4); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    .cp-success-title {
      font-size: 15px; font-weight: 700; letter-spacing: 2px;
      text-transform: uppercase; color: var(--green); margin-bottom: 6px;
    }
    .cp-success-sub {
      font-family: var(--mono); font-size: 11px; color: var(--text-dim);
      line-height: 1.6; margin-bottom: 22px;
    }
    .cp-btn-done {
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.35);
      border-radius: 4px;
      color: var(--green);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 10px 28px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .cp-btn-done:hover { background: rgba(0,255,136,0.18); box-shadow: 0 0 18px rgba(0,255,136,0.18); }

    #app {
      display: none;
    }

    .topbar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
      gap: 10px;
      flex-wrap: wrap;
    }

    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border: 1.5px solid var(--cyan);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--cyan);
      font-family: var(--mono);
      font-size: 14px;
      box-shadow: 0 0 12px rgba(0, 229, 255, 0.2);
    }

    .topbar-brand h1 {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-bright);
    }

    .topbar-brand span {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--cyan-dim);
      letter-spacing: 1px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .folder-bar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #folderBadge {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 5px 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--cyan);
    }

    .user-badge::before {
      content: '‚óè';
      color: var(--green);
      font-size: 8px;
      animation: blink 2s step-end infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0
      }
    }

    .btn-logout {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 1px;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: all .2s;
      text-transform: uppercase;
    }

    .btn-logout:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .main-content {
      padding: 20px;
      max-width: 1300px;
      margin: 0 auto;
    }

    .status-bar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-left: 3px solid var(--cyan);
      border-radius: 4px;
      padding: 8px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--mono);
      font-size: 11px;
    }

    .status-bar .tag {
      color: var(--cyan);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #statusMsg {
      color: var(--text-dim);
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .panel-header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header h2 {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-bright);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-header h2::before {
      content: '';
      display: inline-block;
      width: 3px;
      height: 16px;
      background: var(--cyan);
      border-radius: 2px;
    }

    .panel-body {
      padding: 20px;
    }

    .scan-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-group.two {
      grid-column: span 2;
    }

    .field-group label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--cyan-dim);
      font-family: var(--mono);
    }

    .field-group input,
    .field-group select {
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-bright);
      padding: 9px 12px;
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      transition: all .2s;
    }

    .field-group input:focus,
    .field-group select:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.15);
    }

    .field-group input.filled,
    .field-group select.filled {
      border-color: var(--green);
      background: rgba(0, 255, 136, 0.03);
    }

    .cat-picker-wrap {
      position: relative;
    }

    .cat-display-btn {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-bright);
      padding: 9px 36px 9px 12px;
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      text-align: left;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .cat-display-btn:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.1);
    }

    .cat-display-btn.open {
      border-color: var(--cyan);
      box-shadow: 0 0 10px rgba(0, 229, 255, 0.15);
    }

    .cat-display-btn.filled {
      border-color: var(--green);
      background: rgba(0, 255, 136, 0.03);
    }

    .cat-display-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cat-display-text.placeholder {
      color: var(--text-dim);
    }

    .cat-display-arrow {
      color: var(--cyan-dim);
      font-size: 10px;
      transition: transform .2s;
      flex-shrink: 0;
    }

    .cat-display-btn.open .cat-display-arrow {
      transform: rotate(180deg);
    }

    .cat-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      z-index: 500;
      background: var(--card);
      border: 1px solid rgba(0, 229, 255, 0.3);
      border-radius: 6px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 229, 255, 0.08);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .cat-dropdown.open {
      display: flex;
    }

    .cat-dropdown-search {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .cat-dropdown-search input {
      flex: 1;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text-bright);
      padding: 6px 9px;
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
      transition: border-color .15s;
    }

    .cat-dropdown-search input:focus {
      border-color: var(--cyan);
    }

    .cat-dropdown-search .cat-srch-icon {
      color: var(--cyan-dim);
      font-size: 12px;
      flex-shrink: 0;
    }

    .cat-list {
      overflow-y: auto;
      max-height: 220px;
      flex: 1;
    }

    .cat-opt {
      padding: 8px 14px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      transition: background .1s, color .1s;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .cat-opt:hover {
      background: rgba(0, 229, 255, 0.07);
      color: var(--cyan);
    }

    .cat-opt.selected {
      background: rgba(0, 229, 255, 0.12);
      color: var(--cyan);
      font-weight: 700;
    }

    .cat-opt.hidden {
      display: none;
    }

    .cat-opt-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      flex-shrink: 0;
      opacity: 0;
    }

    .cat-opt.selected .cat-opt-dot {
      opacity: 1;
    }

    .cat-no-results {
      padding: 16px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
      text-align: center;
    }

    .barcode-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
    }

    .btn {
      padding: 9px 16px;
      border: none;
      border-radius: 4px;
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--cyan), var(--cyan-dim));
      color: var(--bg);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 229, 255, 0.4);
    }

    .btn-secondary {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--green), #00cc66);
      color: var(--bg);
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
    }

    .btn-amber {
      background: linear-gradient(135deg, var(--amber), #ff9900);
      color: var(--bg);
    }

    .btn-amber:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(255, 170, 0, 0.4);
    }

    .btn-secondary:hover[style*="border-color:var(--red)"] {
      background: rgba(255, 51, 85, 0.1);
      box-shadow: 0 4px 16px rgba(255, 51, 85, 0.3);
    }

    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    .lookup-status {
      display: none;
      align-items: center;
      gap: 8px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--cyan);
    }

    .lookup-status.show {
      display: flex;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(0, 229, 255, 0.3);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    #reader {
      display: none;
      margin-top: 16px;
      border: 2px solid var(--cyan);
      border-radius: 6px;
      overflow: hidden;
    }

    .import-zone {
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all .2s;
      position: relative;
    }

    .import-zone:hover,
    .import-zone.drag-over {
      border-color: var(--cyan);
      background: rgba(0, 229, 255, 0.03);
    }

    .import-zone input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .iz-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .import-zone p {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-dim);
    }

    .import-zone p span {
      color: var(--cyan);
      text-decoration: underline;
    }

    .import-log {
      margin-top: 16px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      max-height: 160px;
      overflow-y: auto;
      font-family: var(--mono);
      font-size: 11px;
    }

    .import-log>div {
      padding: 4px 0;
      border-bottom: 1px solid rgba(26, 48, 64, 0.4);
    }

    .import-log>div:last-child {
      border-bottom: none;
    }

    .log-ok {
      color: var(--green);
    }

    .log-warn {
      color: var(--amber);
    }

    .import-preview {
      display: none;
      margin-top: 16px;
    }

    .import-preview.show {
      display: block;
    }

    .import-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .import-preview-title {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--cyan);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .import-preview-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .import-preview-count span {
      color: var(--green);
      font-weight: 600;
    }

    .import-preview-count span.upd {
      color: var(--amber);
    }

    .import-preview-table-wrap {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .import-preview-table-wrap table {
      font-size: 11px;
    }

    .import-preview-table-wrap thead th {
      font-size: 9px;
      padding: 7px 10px;
    }

    .import-preview-table-wrap tbody td {
      padding: 7px 10px;
    }

    .row-new td:first-child {
      border-left: 2px solid var(--green);
    }

    .row-update td:first-child {
      border-left: 2px solid var(--amber);
    }

    .badge-new {
      background: rgba(0, 255, 136, 0.12);
      color: var(--green);
      border: 1px solid rgba(0, 255, 136, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      font-family: var(--mono);
    }

    .badge-update {
      background: rgba(255, 170, 0, 0.12);
      color: var(--amber);
      border: 1px solid rgba(255, 170, 0, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      font-family: var(--mono);
    }

    .import-submit-bar {
      display: none;
      margin-top: 14px;
      background: rgba(0, 229, 255, 0.05);
      border: 1px solid rgba(0, 229, 255, 0.2);
      border-radius: 6px;
      padding: 14px 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .import-submit-bar.show {
      display: flex;
    }

    .import-submit-info {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .import-submit-info strong {
      color: var(--cyan);
    }

    .import-submit-actions {
      display: flex;
      gap: 8px;
    }

    .table-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .record-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .record-count span {
      color: var(--cyan);
      font-weight: 600;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--mono);
      font-size: 12px;
    }

    thead {
      background: var(--panel);
      position: sticky;
      top: 0;
    }

    thead th {
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--cyan);
      font-size: 10px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr {
      transition: background .15s;
    }

    tbody tr:hover {
      background: rgba(0, 229, 255, 0.03);
    }

    tbody td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(26, 48, 64, 0.5);
      color: var(--text);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .empty-row td {
      text-align: center;
      color: var(--text-dim);
      font-style: italic;
      padding: 24px;
    }

    .qty {
      color: var(--green);
      font-weight: 600;
    }

    .qty.low {
      color: var(--amber);
    }

    .qty.zero {
      color: var(--red);
    }

    .dir-in {
      color: var(--green);
      font-weight: 600;
    }

    .dir-out {
      color: var(--amber);
      font-weight: 600;
    }

    .dir-ewaste {
      color: var(--ewaste);
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .badge-cyan {
      background: rgba(0, 229, 255, 0.15);
      color: var(--cyan);
      border: 1px solid rgba(0, 229, 255, 0.3);
    }

    .archive-badge {
      background: rgba(255, 170, 0, 0.15);
      color: var(--amber);
      border: 1px solid rgba(255, 170, 0, 0.3);
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      display: inline-block;
    }

    .chart-container {
      position: relative;
      height: 220px;
    }

    .chart-type-btn,
    .chart-filter-btn {
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.5px;
      padding: 4px 9px;
      border-radius: 3px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    .chart-type-btn:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .chart-type-btn.active {
      background: rgba(0, 229, 255, 0.12);
      border-color: var(--cyan);
      color: var(--cyan);
      font-weight: 700;
    }

    .chart-filter-btn:hover {
      border-color: var(--amber);
      color: var(--amber);
    }

    .chart-filter-btn.active {
      background: rgba(255, 170, 0, 0.12);
      border-color: var(--amber);
      color: var(--amber);
      font-weight: 700;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(9, 13, 19, 0.9);
      backdrop-filter: blur(6px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    .modal-box {
      background: var(--card);
      border: 1px solid var(--border-glow);
      border-radius: 8px;
      padding: 32px;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 0 60px rgba(0, 229, 255, 0.15);
      animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
      from {
        transform: translateY(20px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    .modal-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .modal-box h3 {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-bright);
      margin-bottom: 12px;
    }

    .modal-box p {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-box p span {
      color: var(--cyan);
      font-weight: 600;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card);
      border: 1px solid var(--border-glow);
      border-radius: 6px;
      padding: 12px 20px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 3000;
      transform: translateY(120%);
      transition: transform 0.3s ease;
      max-width: 360px;
    }

    .toast.show {
      transform: translateY(0);
    }

    .toast.error {
      border-color: rgba(255, 51, 85, 0.6);
      background: rgba(255, 51, 85, 0.1);
      color: var(--red);
    }

    .toast.warn {
      border-color: rgba(255, 170, 0, 0.6);
      background: rgba(255, 170, 0, 0.1);
      color: var(--amber);
    }

    .toast.delete-single {
      border-color: rgba(255, 51, 85, 0.7);
      background: rgba(20, 8, 12, 0.97);
      color: var(--red);
      border-left: 4px solid var(--red);
      padding: 12px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 24px rgba(255, 51, 85, 0.25);
    }

    .toast.delete-all {
      position: fixed;
      bottom: 32px;
      left: 50%;
      right: auto;
      transform: translateX(-50%) translateY(180%);
      background: rgba(20, 5, 10, 0.98);
      border: 1px solid rgba(255, 51, 85, 0.8);
      border-top: 3px solid var(--red);
      border-radius: 8px;
      padding: 18px 28px;
      text-align: center;
      min-width: 320px;
      max-width: 480px;
      box-shadow: 0 8px 48px rgba(255, 51, 85, 0.35), 0 0 0 1px rgba(255, 51, 85, 0.1);
      color: var(--red);
    }

    .toast.delete-all.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast.delete-all .da-icon {
      font-size: 22px;
      margin-bottom: 6px;
      display: block;
    }

    .toast.delete-all .da-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      display: block;
      margin-bottom: 4px;
    }

    .toast.delete-all .da-sub {
      font-size: 10px;
      color: rgba(255, 51, 85, 0.7);
      letter-spacing: 1px;
      display: block;
    }

    @media(max-width:768px) {
      .topbar {
        flex-direction: column;
        align-items: stretch;
        padding: 12px;
      }

      .topbar-right {
        justify-content: space-between;
      }

      .scan-grid {
        grid-template-columns: 1fr;
      }

      .field-group.two {
        grid-column: span 1;
      }

      #invChartRow {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
  <script>
    (function () {
      const t = localStorage.getItem('itinv_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>

</head>

<body>
  <div id="loginScreen">
    <div class="login-bg-grid"></div>
    <div class="login-box">
      <div class="login-logo">
        <div class="logo-icon">IT</div>
        <h1>it-inventory</h1>
        <p>it-inventory</p>
      </div>
      <div class="login-error" id="loginError">Invalid credentials. Please try again.</div>
      <div class="login-field">
        <label>Username</label>
        <input type="text" id="loginUser"
          onkeydown="if(event.key==='Enter') document.getElementById('loginPass').focus()">
      </div>
      <div class="login-field">
        <label>Password</label>
        <input type="password" id="loginPass" onkeydown="if(event.key==='Enter') doLogin()">
      </div>
      <button type="button" class="btn-login" onclick="doLogin()">Login</button>
      <button type="button" class="btn-change-pw" onclick="openChangePwTab()">üîë Change Password</button>
      <div class="login-hint">Made by <span>LCW</span></div>
    </div>
  </div>

  
  <div id="cpPopup" role="dialog" aria-modal="true" aria-labelledby="cpPopupTitle">
    <div class="cp-box">

      <div class="cp-header">
        <div class="cp-title" id="cpPopupTitle">Change Password</div>
        <button class="cp-close" onclick="closeCpPopup()" title="Close">&#x2715;</button>
      </div>

      
      <div class="cp-body" id="cpForm">
        <div class="cp-field">
          <label>Username</label>
          <input type="text" id="cpUser" placeholder="admin  or  itstaff" autocomplete="username"
            onkeydown="if(event.key==='Enter')document.getElementById('cpCurrent').focus()"
            oninput="cpClearErr()">
        </div>
        <div class="cp-field">
          <label>Current Password</label>
          <input type="password" id="cpCurrent" placeholder="Enter current password" autocomplete="current-password"
            onkeydown="if(event.key==='Enter')document.getElementById('cpNew').focus()"
            oninput="cpClearErr()">
        </div>

        <div class="cp-section-label">New Credentials</div>

        <div class="cp-field">
          <label>New Password</label>
          <input type="password" id="cpNew" placeholder="Min 6 characters" autocomplete="new-password"
            onkeydown="if(event.key==='Enter')document.getElementById('cpConfirm').focus()"
            oninput="cpOnNewInput()">
          <div class="cp-strength">
            <div class="cp-strength-track"><div class="cp-strength-fill" id="cpStrengthFill"></div></div>
            <div class="cp-strength-text" id="cpStrengthText">‚Äî</div>
          </div>
        </div>
        <div class="cp-field">
          <label>Confirm New Password</label>
          <input type="password" id="cpConfirm" placeholder="Re-enter new password" autocomplete="new-password"
            onkeydown="if(event.key==='Enter')cpSubmit()"
            oninput="cpOnConfirmInput()">
        </div>

        <div class="cp-error" id="cpError"></div>

        <div class="cp-actions">
          <button class="cp-btn-cancel" type="button" onclick="closeCpPopup()">Cancel</button>
          <button class="cp-btn-submit" type="button" onclick="cpSubmit()">Update Password</button>
        </div>
      </div>

      
      <div class="cp-success" id="cpSuccess">
        <div class="cp-success-icon">‚úì</div>
        <div class="cp-success-title">Password Updated</div>
        <div class="cp-success-sub">Your password has been changed.<br>Log in with your new credentials.</div>
        <button class="cp-btn-done" onclick="closeCpPopup()">Done</button>
      </div>

    </div>
  </div>

  <div id="app">
    <div class="topbar">
      <div class="topbar-brand">
        <div class="brand-icon">IT</div>
        <div>
          <h1>it-inventory</h1>
          <span>it-inventory</span><span class="sys-sig">¬∑ made by lcw‚Äã‚Äå‚Äã‚Äã‚Äå‚Äå‚Äã‚Äã‚Äç‚Äã‚Äå‚Äã‚Äã‚Äã‚Äã‚Äå‚Äå‚Äç‚Äã‚Äå‚Äã‚Äå‚Äã‚Äå‚Äå‚Äå</span>
        </div>
      </div>
      <div class="topbar-right">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="toggle-icon" id="themeIcon">üåô</span>
        </button>
        <div class="folder-bar">
          <button type="button" class="btn btn-secondary" onclick="selectBaseFolder()">üìÅ Set Base Folder</button>
          <button type="button" class="btn btn-secondary" onclick="scanAllFolders()">üîÑ Scan Folders</button>
          <button type="button" class="btn btn-primary" onclick="openLiveView()">üì∫ Live View</button>
          <button type="button" class="btn btn-secondary" onclick="window.open('it-transactions.html','_blank')"
            style="border-color:var(--amber);color:var(--amber);">üìã it-transactions</button>
          <button type="button" class="btn btn-secondary" onclick="openAssignPage()"
            style="border-color:var(--amber);color:var(--amber);">üë§ it-assign</button>
          <span id="folderBadge">Initializing...</span>
        </div>
        <div class="user-badge" id="userBadge">USER</div>
        <button type="button" class="btn-logout" onclick="doLogout()">Logout</button>
      </div>
    </div>

    <div class="main-content">
      <div class="status-bar">
        <span class="tag">SYS</span>
        <span id="statusMsg">Ready. Click "Set Base Folder" to auto-save inventory data and exports to inventory/archive
          folders.‚Äã‚Äå‚Äã‚Äã‚Äå‚Äå‚Äã‚Äã‚Äç‚Äã‚Äå‚Äã‚Äã‚Äã‚Äã‚Äå‚Äå‚Äç‚Äã‚Äå‚Äã‚Äå‚Äã‚Äå‚Äå‚Äå</span>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>Scan Item</h2>
          <div class="lookup-status" id="lookupStatus">
            <div class="spinner"></div><span>Looking up product data...</span>
          </div>
        </div>
        <div class="panel-body">
          <div class="scan-grid">
            <div class="field-group two">
              <label>Barcode / Asset Tag</label>
              <div class="barcode-row">
                <input type="text" id="barcode" placeholder="Scan or type barcode..." autofocus
                  onkeydown="if(event.key==='Enter') lookupBarcode()" oninput="autoFillSerial(this.value)">
                <button type="button" class="btn btn-primary" onclick="lookupBarcode()">Lookup</button>
                <button type="button" class="btn btn-secondary" onclick="toggleCamera()">Camera</button>
              </div>
            </div>
            <div class="field-group">
              <label>Location</label>
              <input type="text" id="location" value="IT Office">
            </div>
            <div class="field-group two">
              <label>Product Name</label>
              <input type="text" id="productName" placeholder="Auto-filled from lookup...">
            </div>
            <div class="field-group">
              <label>Category</label>
              <div class="cat-picker-wrap" id="catPickerWrap">
                <button type="button" class="cat-display-btn" id="catDisplayBtn" onclick="toggleCatDropdown()"
                  tabindex="0">
                  <span class="cat-display-text placeholder" id="catDisplayText">-- Select or auto-filled --</span>
                  <span class="cat-display-arrow">‚ñº</span>
                </button>
                <div class="cat-dropdown" id="catDropdown">
                  <div class="cat-dropdown-search">
                    <span class="cat-srch-icon">üîç</span>
                    <input type="text" id="catSearchInput" placeholder="Filter categories..." autocomplete="off"
                      oninput="filterCatOptions(this.value)" onclick="event.stopPropagation()">
                  </div>
                  <div class="cat-list" id="catList"></div>
                </div>

                <select id="category" style="display:none;"></select>
              </div>
            </div>
            <div class="field-group two">
              <label>Model / Brand</label>
              <input type="text" id="model" placeholder="Auto-filled...">
            </div>
            <div class="field-group">
              <label>Serial Number <span style="font-size:9px;color:var(--cyan-dim);font-weight:400;">(auto from
                  scan)</span></label>
              <input type="text" id="serial" placeholder="Auto-filled from barcode..."
                oninput="this.dataset.manual = (this.value.trim() !== document.getElementById('barcode').value.trim()) ? '1' : ''">
            </div>
            <div class="field-group">
              <label>Direction</label>
              <select id="direction" onchange="onDirectionChange(this.value)">
                <option value="IN">IN</option>
                <option value="OUT">OUT</option>
                <option value="E-WASTE">‚ôª E-WASTE</option>
              </select>
            </div>
            <div class="field-group">
              <label>Quantity</label>
              <input type="number" id="quantity" value="1" min="1">
            </div>
          </div>
          <div id="reader"></div>
          <div id="sourceTag"
            style="display:none;margin-top:12px;font-family:var(--mono);font-size:11px;color:var(--text-dim);">
            Source: <span id="sourceLabel" style="color:var(--cyan);"></span>
            &nbsp;&middot;&nbsp; Category: <span id="catLabel" style="color:var(--green);"></span>
          </div>
          <div class="action-row">
            <button type="button" class="btn btn-success" id="submitBtn" onclick="processScan()">&#10003; Submit
              Transaction</button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>Import Inventory Data</h2>
        </div>
        <div class="panel-body">
          <div class="import-zone" id="importZone" ondragover="event.preventDefault();this.classList.add('drag-over')"
            ondragleave="this.classList.remove('drag-over')" ondrop="handleFileDrop(event)">
            <input type="file" id="importFileInput" accept=".pdf,.xlsx,.xls,.csv" multiple
              onchange="handleImportFiles(this.files)">
            <div class="iz-icon">üìÑ</div>
            <p><span>Click to select</span> or drag &amp; drop inventory files here.</p>
            <p style="margin-top:4px;font-size:10px;">Supports: Excel (.xlsx, .xls), CSV, PDF ‚Ä¢ Multiple files supported
            </p>
          </div>
          <div class="import-log" id="importLog"></div>

          <div class="import-preview" id="importPreview">
            <div class="import-preview-header">
              <span class="import-preview-title">‚ö† Preview ‚Äî Not yet submitted</span>
              <span class="import-preview-count">
                <span id="previewNewCount">0</span> new &nbsp;¬∑&nbsp;
                <span class="upd" id="previewUpdateCount">0</span> updates &nbsp;¬∑&nbsp;
                <span id="previewTotalCount">0</span> total
              </span>
            </div>
            <div class="import-preview-table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Status</th>
                    <th>Barcode</th>
                    <th>Product</th>
                    <th>Model</th>
                    <th>Category</th>
                    <th>Qty</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody id="importPreviewTable"></tbody>
              </table>
            </div>
          </div>

          <div class="import-submit-bar" id="importSubmitBar">
            <div class="import-submit-info">
              Ready to commit <strong id="submitBarCount">0</strong> items to inventory and sync live view.
            </div>
            <div class="import-submit-actions">
              <button type="button" class="btn btn-secondary" onclick="discardImport()">‚úï Discard</button>
              <button type="button" class="btn btn-success" onclick="submitImport()">‚úì Submit to Inventory</button>
            </div>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:20px;" id="invChartRow">
        <div class="panel" style="margin-bottom:0;">
          <div class="panel-header">
            <h2>Inventory</h2>
          </div>
          <div class="panel-body">
            <div class="table-toolbar">
              <div class="record-count">Items: <span id="invCount">0</span> &nbsp;|&nbsp; Units: <span
                  id="invUnits">0</span></div>
              <div style="display:flex;gap:8px;">
                <button type="button" class="btn btn-amber" onclick="exportPDF()">&#8595; Export PDF</button>
                <button type="button" class="btn btn-secondary" onclick="clearAllInventory()"
                  style="border-color:var(--red);color:var(--red);">üóëÔ∏è Clear All</button>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Barcode</th>
                    <th>Product</th>
                    <th>Model</th>
                    <th>Category</th>
                    <th>Qty</th>
                    <th>Location</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-bottom:0;">
          <div class="panel-header" style="flex-direction:column;align-items:stretch;gap:8px;padding:12px 16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <h2>Stock by Category</h2>
            </div>
            <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
              <span
                style="font-family:var(--mono);font-size:10px;color:var(--cyan-dim);letter-spacing:1px;text-transform:uppercase;margin-right:2px;">Type:</span>
              <button class="chart-type-btn active" onclick="setMainChartType('bar')" data-type="bar">‚ñê‚ñã Bar</button>
              <button class="chart-type-btn" onclick="setMainChartType('line')" data-type="line">üìà Line</button>
              <button class="chart-type-btn" onclick="setMainChartType('pie')" data-type="pie">ü•ß Pie</button>
              <button class="chart-type-btn" onclick="setMainChartType('doughnut')" data-type="doughnut">‚≠ï Ring</button>
              <button class="chart-type-btn" onclick="setMainChartType('polarArea')" data-type="polarArea">üéØ
                Polar</button>
            </div>
            <div style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
              <span
                style="font-family:var(--mono);font-size:10px;color:var(--cyan-dim);letter-spacing:1px;text-transform:uppercase;margin-right:2px;">Show:</span>
              <button class="chart-filter-btn active" onclick="setMainChartFilter('all')" data-f="all">All</button>
              <button class="chart-filter-btn" onclick="setMainChartFilter('instock')" data-f="instock">In
                Stock</button>
              <button class="chart-filter-btn" onclick="setMainChartFilter('low')" data-f="low">‚ö† Low</button>
              <button class="chart-filter-btn" onclick="setMainChartFilter('zero')" data-f="zero">üî¥ Zero</button>
              <button class="chart-filter-btn" onclick="setMainChartFilter('topcat')" data-f="topcat">Top 8</button>
              <button class="chart-filter-btn" onclick="setMainChartFilter('ewaste')" data-f="ewaste"
                style="color:#a855f7;border-color:rgba(168,85,247,0.4);">‚ôª E-Waste</button>
            </div>
          </div>
          <div class="panel-body" style="padding:12px;">
            <div class="chart-container"><canvas id="stockChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:20px;">
        <div class="panel-header">
          <h2>Archive (Checked-Out)</h2>
        </div>
        <div class="panel-body">
          <div class="table-toolbar">
            <div class="record-count">Archived: <span id="archiveCount">0</span></div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Barcode</th>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Qty Out</th>
                  <th>Status</th>
                  <th>Location</th>
                </tr>
              </thead>
              <tbody id="archiveTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>Transactions</h2>
        </div>
        <div class="panel-body">
          <div class="table-toolbar">
            <div class="record-count">Total: <span id="txCount">0</span></div>
            <button type="button" class="btn btn-amber" onclick="manualExportTransactions()"
              style="font-size:11px;padding:6px 12px;">üìÑ Export & Clear Transactions</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Barcode</th>
                  <th>Product</th>
                  <th>Serial</th>
                  <th>Direction</th>
                  <th>Qty</th>
                </tr>
              </thead>
              <tbody id="transactionTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="stockModal">
    <div class="modal-box">
      <div class="modal-icon">üö´</div>
      <h3>Insufficient Stock</h3>
      <p id="stockModalMsg">Not enough units available.</p>
      <button type="button" class="btn btn-secondary" onclick="closeStockModal()">DISMISS</button>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal">
    <div class="modal-box"
      style="max-width:460px;text-align:center;border-color:rgba(255,51,85,0.4);box-shadow:0 0 60px rgba(255,51,85,0.15);">
      <div
        style="width:64px;height:64px;border:2px solid var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:28px;box-shadow:0 0 24px rgba(255,51,85,0.3);">
        üóë</div>
      <h3 style="color:var(--red);letter-spacing:2px;margin-bottom:8px;">DELETE ITEM</h3>
      <p
        style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:20px;text-transform:uppercase;">
        This action cannot be undone</p>
      <div
        style="background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:24px;text-align:left;">
        <div
          style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">
          Item to be deleted</div>
        <div id="deleteModalProduct" style="font-size:15px;font-weight:700;color:var(--text-bright);margin-bottom:4px;">
        </div>
        <div id="deleteModalBarcode" style="font-family:var(--mono);font-size:11px;color:var(--cyan-dim);"></div>
        <div id="deleteModalMeta" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-top:6px;">
        </div>
      </div>
      <div style="margin-bottom:20px;text-align:left;">
        <label
          style="font-family:var(--mono);font-size:10px;color:var(--cyan-dim);letter-spacing:2px;text-transform:uppercase;display:block;margin-bottom:6px;">Enter
          password to confirm</label>
        <input type="password" id="deleteModalPassword" placeholder="Password..."
          style="width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:4px;color:var(--text-bright);padding:10px 14px;font-family:var(--mono);font-size:13px;outline:none;transition:border-color .2s;"
          onkeydown="if(event.key==='Enter') document.getElementById('deleteModalConfirmBtn').click()">
        <div id="deleteModalPassError"
          style="color:var(--red);font-family:var(--mono);font-size:11px;margin-top:6px;display:none;">‚ùå Incorrect
          password</div>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()"
          style="flex:1;max-width:160px;">CANCEL</button>
        <button type="button" id="deleteModalConfirmBtn"
          style="flex:1;max-width:160px;background:linear-gradient(135deg,#ff3355,#cc1133);color:#fff;border:none;border-radius:4px;font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 16px;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(255,51,85,0.3);">CONFIRM
          DELETE</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="clearAllModal">
    <div class="modal-box"
      style="max-width:480px;text-align:center;border-color:rgba(255,51,85,0.4);box-shadow:0 0 60px rgba(255,51,85,0.2);">
      <div
        style="width:64px;height:64px;border:2px solid var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:28px;box-shadow:0 0 24px rgba(255,51,85,0.3);">
        ‚ö†Ô∏è</div>
      <h3 style="color:var(--red);letter-spacing:2px;margin-bottom:8px;">CLEAR ALL INVENTORY</h3>
      <p id="clearAllModalMsg"
        style="font-family:var(--mono);font-size:12px;color:var(--text);margin-bottom:20px;line-height:1.7;"></p>
      <div id="clearAllStep1">
        <div style="display:flex;gap:10px;justify-content:center;">
          <button type="button" class="btn btn-secondary" onclick="closeClearAllModal()"
            style="flex:1;max-width:160px;">CANCEL</button>
          <button type="button"
            style="flex:1;max-width:200px;background:linear-gradient(135deg,#ff3355,#cc1133);color:#fff;border:none;border-radius:4px;font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 16px;cursor:pointer;box-shadow:0 4px 16px rgba(255,51,85,0.3);"
            onclick="clearAllStep2()">YES, CONTINUE</button>
        </div>
      </div>
      <div id="clearAllStep2" style="display:none;">
        <div style="margin-bottom:16px;text-align:left;">
          <label
            style="font-family:var(--mono);font-size:10px;color:var(--cyan-dim);letter-spacing:2px;text-transform:uppercase;display:block;margin-bottom:6px;">Enter
            your password to confirm</label>
          <input type="password" id="clearAllPassword" placeholder="Password..."
            style="width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:4px;color:var(--text-bright);padding:10px 14px;font-family:var(--mono);font-size:13px;outline:none;"
            onkeydown="if(event.key==='Enter')clearAllStep3()">
          <div id="clearAllPassError"
            style="color:var(--red);font-family:var(--mono);font-size:11px;margin-top:6px;display:none;">‚ùå Incorrect
            password</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;">
          <button type="button" class="btn btn-secondary" onclick="closeClearAllModal()"
            style="flex:1;max-width:160px;">CANCEL</button>
          <button type="button"
            style="flex:1;max-width:200px;background:linear-gradient(135deg,#ff3355,#cc1133);color:#fff;border:none;border-radius:4px;font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 16px;cursor:pointer;box-shadow:0 4px 16px rgba(255,51,85,0.3);"
            onclick="clearAllStep3()">VERIFY & DELETE ALL</button>
        </div>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

<script>
    (function () {
      const saved = localStorage.getItem('itinv_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      const icon = document.getElementById('themeIcon');
      if (icon) icon.textContent = saved === 'light' ? '‚òÄÔ∏è' : 'üåô';
    })();

    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('itinv_theme', next);
      const icon = document.getElementById('themeIcon');
      if (icon) icon.textContent = next === 'light' ? '‚òÄÔ∏è' : 'üåô';
    }

    const USERS = { admin: { password: "admin123", displayName: "ADMIN" }, itstaff: { password: "staff456", displayName: "IT STAFF" } };
    (function(){
      try {
        const _s = JSON.parse(localStorage.getItem('itinv_user_passwords') || '{}');
        Object.keys(_s).forEach(u => { if(USERS[u]) USERS[u].password = _s[u]; });
      } catch(e){}
    })();
    let currentUser = null, scannerActive = false, html5Scanner = null, stockChartInst = null;

    function doLogin() {
      try {
        const user = document.getElementById("loginUser").value.trim().toLowerCase();
        const pass = document.getElementById("loginPass").value;
        const errEl = document.getElementById("loginError");
        if (USERS[user] && USERS[user].password === pass) {
          currentUser = user;
          localStorage.setItem("itinv_currentUser", user);
          errEl.style.display = "none";
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("app").style.display = "block";
          document.getElementById("userBadge").textContent = USERS[user].displayName;
          setStatus("Logged in as " + USERS[user].displayName + " ‚Äî ready.");

          if (typeof refreshTimer !== 'undefined' && refreshTimer) { cancelAnimationFrame(refreshTimer); refreshTimer = null; }
          if (typeof chartRefreshTimer !== 'undefined' && chartRefreshTimer) { clearTimeout(chartRefreshTimer); chartRefreshTimer = null; }
          initCatPicker();
          refreshAll();
        } else {
          errEl.style.display = "block";
          document.getElementById("loginPass").value = "";
          document.getElementById("loginPass").focus();
        }
      } catch (e) {
        alert("Login error: " + e.message);
      }
    }
    function doLogout() {
      currentUser = null;

      localStorage.removeItem("itinv_currentUser");
      ["loginUser", "loginPass"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("loginError").style.display = "none";
      document.getElementById("app").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
      if (html5Scanner) { html5Scanner.stop().catch(() => { }); scannerActive = false; document.getElementById("reader").style.display = "none"; }
    }

    function load(k, def) { try { return JSON.parse(localStorage.getItem(k)) || def; } catch (e) { return def; } }

    

    let inventory = load("itinv_inventory", {}), transactions = load("itinv_transactions", []), archive = load("itinv_archive", []);
    function persist() {
      localStorage.setItem("itinv_inventory", JSON.stringify(inventory));
      localStorage.setItem("itinv_transactions", JSON.stringify(transactions));
      localStorage.setItem("itinv_archive", JSON.stringify(archive));
      try {
        const wins = window._liveViewWindows || [];
        const msg = { type: 'itinv_update', inventory: inventory, lowThreshold: 2 };
        wins.forEach(w => { if (w && !w.closed) w.postMessage(msg, '*'); });
      } catch (e) { }
    }

    let baseFolderHandle = null, inventoryFolderHandle = null, archiveFolderHandle = null, transactionsFolderHandle = null;
    function openIDB() { return new Promise((res, rej) => { const req = indexedDB.open("itinv_fs", 1); req.onupgradeneeded = e => e.target.result.createObjectStore("handles"); req.onsuccess = e => res(e.target.result); req.onerror = e => rej(e.target.error); }); }
    async function loadHandleFromIDB() { try { const db = await openIDB(); const tx = db.transaction("handles", "readonly"); const req = tx.objectStore("handles").get("baseFolder"); return new Promise(res => { req.onsuccess = () => res(req.result || null); req.onerror = () => res(null); }); } catch (e) { return null; } }
    async function saveHandleToIDB(h) { try { const db = await openIDB(); const tx = db.transaction("handles", "readwrite"); tx.objectStore("handles").put(h, "baseFolder"); } catch (e) { } }
    function updateFolderBadge(name) { const el = document.getElementById("folderBadge"); if (!el) return; if (name) { el.textContent = "üìÅ " + name; el.style.color = "var(--green)"; } else { el.textContent = "Initializing..."; el.style.color = "var(--text-dim)"; } }

    async function selectBaseFolder() {
      if (!window.showDirectoryPicker) {
        showToast("Folder picker not supported in this browser. Please use Chrome, Edge, or Opera.", "error");
        setStatus("‚ö† Browser not compatible with File System Access API. Use Chrome/Edge/Opera for auto-save.");
        return;
      }
      try {

        const h = await window.showDirectoryPicker({ mode: "readwrite" });
        baseFolderHandle = h;
        await saveHandleToIDB(h);

        try {
          inventoryFolderHandle = await baseFolderHandle.getDirectoryHandle("inventory", { create: true });
          archiveFolderHandle = await baseFolderHandle.getDirectoryHandle("archive", { create: true });
          transactionsFolderHandle = await baseFolderHandle.getDirectoryHandle("transactions", { create: true });
          updateFolderBadge("‚úì " + h.name);
          showToast("‚úì Auto-save enabled! PDFs & data will save to: " + h.name);
          setStatus("‚úì Auto-save active ‚Äî All PDFs and data will automatically save to: " + h.name + "/inventory and /archive");

          await scanAllFolders();

          if (Object.keys(inventory).length > 0) {
            await saveInventoryToFolder();
            showToast("‚úì Current inventory saved to folder");
          }
        } catch (e) {
          console.error("Subfolder creation error:", e);
          showToast("Could not create subfolders: " + e.message, "error");
        }
      } catch (e) {
        if (e.name !== "AbortError") {
          console.error("Folder selection error:", e);
          showToast("Could not set folder: " + e.message, "error");
        }
      }
    }

    async function scanAllFolders() {
      if (!inventoryFolderHandle || !archiveFolderHandle) {
        showToast("Please set base folder first", "warn");
        return;
      }

      setStatus("Scanning folders for data...");
      await loadFromAllSources();
      refreshAll();
      showToast("Loaded " + Object.keys(inventory).length + " items from folders");
      setStatus("Synced with " + baseFolderHandle.name + "/inventory & /archive");
    }

    async function loadFromAllSources() {
      if (!inventoryFolderHandle || !archiveFolderHandle) return;

      let totalLoaded = 0;

      try {

        let inventoryFiles = [];

        for await (const entry of inventoryFolderHandle.values()) {
          if (entry.kind !== "file") continue;
          const fname = entry.name.toLowerCase();

          if (fname.startsWith("inventory_") && fname.endsWith(".json")) {
            inventoryFiles.push({ entry, name: fname });
          }

          else if (fname.endsWith(".csv")) {
            await loadCSVFile(entry);
          }
        }

        if (inventoryFiles.length > 0) {
          inventoryFiles.sort((a, b) => b.name.localeCompare(a.name));
          const latestFile = inventoryFiles[0];
          console.log("üìÇ Loading latest inventory file:", latestFile.name);
          totalLoaded = await loadJSONFile(latestFile.entry);
          console.log("‚úì Loaded", totalLoaded, "items from", latestFile.name);

          if (inventoryFiles.length > 5) {
            console.log("üóëÔ∏è Cleaning up old inventory files (keeping 5 most recent)");
            for (let i = 5; i < inventoryFiles.length; i++) {
              try {
                await inventoryFolderHandle.removeEntry(inventoryFiles[i].name);
                console.log("  Deleted:", inventoryFiles[i].name);
              } catch (e) {
                console.warn("  Could not delete:", inventoryFiles[i].name, e.message);
              }
            }
          }
        }

        await loadArchiveFromFolder();

        await loadTransactionsFromFolder();

      } catch (e) {
        console.error("Load from sources error:", e);
      }

      return totalLoaded;
    }

    async function loadJSONFile(fileEntry) {
      try {
        const file = await fileEntry.getFile();
        const text = await file.text();
        const data = JSON.parse(text);

        let count = 0;

        if (data.inventory) {

          for (const [barcode, item] of Object.entries(data.inventory)) {
            inventory[barcode] = item;
            count++;
          }

          if (data.transactions && Array.isArray(data.transactions)) {
            transactions = data.transactions;
          }
        } else if (Array.isArray(data)) {

          for (const item of data) {
            if (item.barcode) {
              if (!inventory[item.barcode]) {
                inventory[item.barcode] = {
                  barcode: item.barcode,
                  product: item.product || item.name || "Unknown",
                  model: item.model || item.brand || "",
                  category: item.category || "IT Equipment",
                  qty: parseInt(item.qty || item.quantity || 0),
                  location: item.location || "IT Office"
                };
                count++;
              } else {

                inventory[item.barcode].qty += parseInt(item.qty || item.quantity || 0);
              }
            }
          }
        } else if (data.barcode) {

          if (!inventory[data.barcode]) {
            inventory[data.barcode] = data;
            count++;
          } else {

            inventory[data.barcode].qty += (data.qty || 0);
          }
        }

        return count;
      } catch (e) {
        console.error("Load JSON error:", e);
        return 0;
      }
    }

    async function loadCSVFile(fileEntry) {
      try {
        const file = await fileEntry.getFile();
        const text = await file.text();
        const rows = parseCSVToRows(text);
        if (rows.length < 2) return 0;
        const detected = detectHeaderRow(rows);
        if (!detected) return 0;
        const { dataStartRow, colMap } = detected;
        let count = 0;
        for (let r = dataStartRow; r < rows.length; r++) {
          const item = parseDataRow(rows[r], colMap);
          if (item && !inventory[item.barcode]) {
            inventory[item.barcode] = item;
            count++;
          }
        }
        return count;
      } catch (e) {
        console.error("Load CSV error:", e);
        return 0;
      }
    }

    const TRANSACTIONS_FILE = "transactions.json";
    const ARCHIVE_FILE = "archive.json";

    async function readFromFolder(folderHandle, filename) {
      if (!folderHandle) return null;
      try {
        const fh = await folderHandle.getFileHandle(filename);
        const file = await fh.getFile();
        const text = await file.text();
        return JSON.parse(text);
      } catch (e) {

        return null;
      }
    }

    async function loadArchiveFromFolder() {
      if (!archiveFolderHandle) {
        return;
      }
      try {
        const data = await readFromFolder(archiveFolderHandle, ARCHIVE_FILE);
        if (data && Array.isArray(data)) {
          archive = data;
        }
      } catch (e) {
        console.error("Load archive error:", e);
      }
    }

    async function loadTransactionsFromFolder() {
      if (!inventoryFolderHandle) {
        transactions = [];
        return;
      }

      try {
        const data = await readFromFolder(inventoryFolderHandle, TRANSACTIONS_FILE);
        if (data && Array.isArray(data)) {
          transactions = data;
        } else {
          transactions = [];
        }
      } catch (e) {
        console.error("Load transactions error:", e);
        transactions = [];
      }
    }

    async function ensureFolderPermission(folderHandle) {
      if (!folderHandle) return false;
      try {
        let p = await folderHandle.queryPermission({ mode: "readwrite" });
        if (p !== "granted") p = await folderHandle.requestPermission({ mode: "readwrite" });
        if (p !== "granted") {
          baseFolderHandle = null; inventoryFolderHandle = null; archiveFolderHandle = null;
          updateFolderBadge(null);
          return false;
        }
        return true;
      } catch (e) { return false; }
    }

    async function writeToFolder(folderHandle, blob, filename) {
      if (!folderHandle || !(await ensureFolderPermission(folderHandle))) return false;
      try {
        const fh = await folderHandle.getFileHandle(filename, { create: true });
        const w = await fh.createWritable();
        await w.write(blob);
        await w.close();
        return true;
      } catch (e) {
        console.warn("Folder write failed:", e.message);
        return false;
      }
    }

    let saveFolderTimer = null;

    async function saveInventoryToFolder() {
      if (!inventoryFolderHandle) return false;

      if (saveFolderTimer) {
        clearTimeout(saveFolderTimer);
      }

      return new Promise((resolve) => {
        saveFolderTimer = setTimeout(async () => {
          try {
            const items = Object.values(inventory);
            if (items.length === 0) {
              resolve(false);
              return;
            }

            const data = {
              savedAt: new Date().toISOString(),
              user: currentUser || "unknown",
              inventory: inventory,
              transactions: transactions
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const ts = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
            const filename = "inventory_" + ts + ".json";

            const saved = await writeToFolder(inventoryFolderHandle, blob, filename);
            if (saved) {

              console.log("‚úì Inventory auto-saved to folder");
              resolve(true);
            } else {
              resolve(false);
            }
          } catch (e) {
            console.error("Save inventory error:", e);
            resolve(false);
          }
        }, 500);
      });
    }

    async function archiveProduct(item) {
      if (!archiveFolderHandle) return false;
      try {
        const data = {
          archivedAt: item.archivedAt || new Date().toISOString(),
          user: currentUser || "unknown",
          barcode: item.barcode,
          product: item.product,
          model: item.model,
          category: item.category,
          location: item.location,
          finalQty: 0,
          status: "OUT OF STOCK - Item depleted, check IN to restore",
          note: "This item is in the archive. To restore to inventory, scan barcode and check IN new stock."
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const ts = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
        const filename = "archived_" + item.barcode + "_" + ts + ".json";

        const saved = await writeToFolder(archiveFolderHandle, blob, filename);
        if (saved) {
          console.log("üì¶ Product archived to /archive:", item.product, "(No stock available)");

          setTimeout(() => {
            saveInventoryToFolder().catch(e => console.warn("Post-archive save failed:", e));
          }, 1000);

          return true;
        }
        return false;
      } catch (e) {
        console.error("Archive product error:", e);
        return false;
      }
    }

    (async () => {
      try {
        const h = await loadHandleFromIDB();
        if (h) {
          const p = await h.queryPermission({ mode: "readwrite" });
          if (p === "granted") {
            baseFolderHandle = h;
            try {
              inventoryFolderHandle = await baseFolderHandle.getDirectoryHandle("inventory", { create: true });
              archiveFolderHandle = await baseFolderHandle.getDirectoryHandle("archive", { create: true });
              transactionsFolderHandle = await baseFolderHandle.getDirectoryHandle("transactions", { create: true });
              updateFolderBadge(h.name);
              setStatus("‚úì Auto-save ready ‚Äî Folder: " + h.name + "/inventory & /archive");
              showToast("‚úì Auto-save connected to: " + h.name);

              console.log("üìÇ Loading data from folders...");
              await loadFromAllSources();
              refreshAll();
              const itemCount = Object.keys(inventory).length;
              if (itemCount > 0) {
                showToast("‚úì Loaded " + itemCount + " items from folder");
                setStatus("‚úì Loaded " + itemCount + " items from " + h.name + "/inventory");
              }
            } catch (e) {
              console.error("Error creating subfolders:", e);
              setStatus("‚ö† Could not create inventory/archive folders. Click folder button to reselect.");
            }
          } else {

            setStatus("‚ö† Folder access needed ‚Äî Click 'Select Base Folder' to enable auto-save");
            showToast("Click 'Select Base Folder' to enable auto-saving", "warn");
          }
        } else {

          setStatus("‚ö† No folder selected ‚Äî Click 'Select Base Folder' to enable auto-save of PDFs and data");
        }
      } catch (e) {
        console.error("Folder restoration error:", e);
        setStatus("‚ö† Click 'Select Base Folder' to set up auto-save");
      }
    })();

    const CR = [

      { cat: "Blade Server", rx: /blade server|blade chassis|bladecenter|c-class blade/i },
      { cat: "Server", rx: /\bserver\b|poweredge|proliant|powervault|superserver|rack server|tower server|xeon\b(?=.*server)|sun sparc/i },
      { cat: "Workstation", rx: /workstation|thinkstation|precision\s+t\d|z[234]\d0\b|z\d{3,4} tower|hpe z\d/i },
      { cat: "All-in-One PC", rx: /all.in.one|aio\b|imac\b|optiplex\s+\d+\s+aio|eliteone|proone/i },
      { cat: "Thin Client", rx: /thin client|wyse\b|igel\b|hp t\d{3,}|zero client/i },
      { cat: "Micro PC / NUC", rx: /\bnuc\b|mini pc|micro pc|intel nuc|beelink|minisforum|compute stick/i },
      { cat: "Chromebook", rx: /chromebook|chromebox|chromebase/i },
      { cat: "Desktop", rx: /desktop|tower|optiplex|prodesk|thinkcentre|elitedesk|veriton|aspire tc|inspiron desktop/i },
      { cat: "Laptop", rx: /laptop|notebook|macbook|thinkpad|elitebook|probook|zbook|latitude\b|inspiron \d{4}|xps \d{2}|pavilion|envy\b|spectre|omen\b|ideapad|yoga\b|swift\b|aspire [ae]\d|gram\b|surface laptop|surface book/i },

      { cat: "Rugged Device", rx: /rugged|toughbook|toughpad|xplore|getac|panasonic cf-|zebra tc[0-9]/i },
      { cat: "Tablet", rx: /\btablet\b|ipad|surface pro|surface go|galaxy tab|fire hd|kindle fire|mediapad|xperia tab/i },
      { cat: "Smartphone", rx: /smartphone|iphone|galaxy [as]\d|pixel \d|oneplus|redmi|xperia\b(?!.*tab)|blackberry|nokia \d{4}/i },
      { cat: "Wearable", rx: /smartwatch|apple watch|fitbit|garmin watch|wearable|band \d|galaxy watch/i },

      { cat: "Storage Array", rx: /storage array|all.flash array|aff\b|pure storage|nimble|3par|xiv\b|isilon|powerstore/i },
      { cat: "SAN", rx: /\bsan\b|storage area network|brocade san|fibre channel switch/i },
      { cat: "NAS", rx: /\bnas\b|network.attached storage|synology|qnap|readynas|drobo|terramaster/i },
      { cat: "RAID Controller", rx: /raid controller|raid card|lsi\b|megaraid|hba\b|host bus adapter/i },
      { cat: "NVMe Drive", rx: /nvme|m\.2 drive|m2 ssd|pcie ssd|u\.2 drive/i },
      { cat: "SSD", rx: /\bssd\b|solid.?state|2\.5.ssd|sata ssd|crucial mx|samsung 870|samsung 860|wd blue ssd/i },
      { cat: "Hard Drive", rx: /hard drive|\bhdd\b|hard disk|spinning disk|sata drive|seagate|western digital|wd red|wd purple|barracuda\b|ironwolf/i },
      { cat: "Tape Drive", rx: /tape drive|tape library|lto\b|dat drive|dlt\b|ultrium|ts\d{4}[fh]/i },
      { cat: "Optical Drive", rx: /optical drive|dvd drive|blu.?ray drive|cd.?rw|dvd.?rw|dvd.?rom/i },
      { cat: "SD Card", rx: /sd card|microsd|compact flash|cfexpress|memory card|xqd card/i },
      { cat: "USB Drive", rx: /usb drive|usb stick|flash drive|thumb drive|pendrive|pen drive/i },

      { cat: "CPU / Processor", rx: /\bcpu\b|processor|\bintel core\b|core i[3579]|ryzen\b|xeon\b|celeron|pentium|athlon|threadripper/i },
      { cat: "RAM / Memory", rx: /\bram\b|\bdimm\b|so-dimm|memory module|ddr[345]|rdimm|lrdimm|ecc memory|32gb\s+ddr|16gb\s+ddr/i },
      { cat: "GPU / Graphics", rx: /\bgpu\b|graphics card|geforce|radeon|quadro\b|rtx\s*\d|gtx\s*\d|rx\s*\d{4}|firepro|nvidia a\d{3,}/i },
      { cat: "Motherboard", rx: /motherboard|mainboard|system board|asus\s+[a-z]\d{3}|msi\s+[a-z]\d{3}|gigabyte\s+[a-z]\d{3}/i },
      { cat: "Expansion Card", rx: /expansion card|pcie card|pci card|fibre channel card|infiniband|10gbe card|25gbe card/i },
      { cat: "Sound Card", rx: /sound card|audio card|creative\s+sound|focusrite(?!.*interface)|m-audio\b(?!.*interface)/i },
      { cat: "Cooling / Fan", rx: /cpu cooler|heatsink|case fan|liquid cooling|aio cooler|water cooling|thermal paste|noctua|be quiet/i },
      { cat: "Power Supply", rx: /power supply|\bpsu\b|atx psu|modular psu|evga\s+\d+w|corsair\s+\d+w/i },
      { cat: "Battery / CMOS", rx: /cmos battery|laptop battery|replacement battery|battery pack(?!.*ups)|li.?ion pack/i },

      { cat: "Video Wall Controller", rx: /video wall|videowall|display wall controller|rgb controller(?!.*fan)/i },
      { cat: "Display Port Splitter", rx: /display splitter|hdmi splitter|vga splitter|video splitter|display distributor/i },
      { cat: "Digital Signage", rx: /digital signage|signage player|signage display|advertising display|info screen|brightsign/i },
      { cat: "Projector", rx: /projector|beamer\b|epson eb-|benq th\d|optoma\b|viewsonic px/i },
      { cat: "Monitor", rx: /monitor|display\b(?!.*switch|.*hub|.*port)|lcd\b|led screen|ultrawide|benq\b|viewsonic v|dell [up]\d{4}|lg \d{2}[a-z][nkq]|acer [a-z]\d{3}|27"|32"|24"|21.5"/i },

      { cat: "KVM over IP", rx: /kvm over ip|remote kvm|ipkvm|aten ip\d|raritan dominion|digi passport/i },
      { cat: "KVM Switch", rx: /\bkvm\b|kvm switch|keyboard video mouse/i },

      { cat: "Graphics Tablet", rx: /graphics tablet|drawing tablet|wacom|huion|xp-pen|pen tablet/i },
      { cat: "Signature Pad", rx: /signature pad|e-signature|sign pad|topaz sig|wacom sign/i },
      { cat: "Biometric Scanner", rx: /fingerprint (reader|scanner)|iris scanner|biometric (reader|scanner|terminal)|facial recognition/i },
      { cat: "RFID Reader", rx: /rfid reader|rfid scanner|rfid tag|nfc reader|near field/i },
      { cat: "Card Reader", rx: /card reader|smart card reader|id card reader|cac reader|credit card terminal|payment terminal/i },
      { cat: "Barcode Scanner", rx: /barcode (scanner|reader)|barcode gun|qr scanner|qr reader|handheld scanner|datalogic|honeywell (voyager|xenon)|zebra ds\d/i },
      { cat: "Trackpad / Trackball", rx: /trackpad|touchpad|trackball|magic trackpad/i },
      { cat: "Mouse", rx: /\bmouse\b|optical mouse|wireless mouse|gaming mouse|mx master|mx anywhere|mx keys|logitech m\d{3}/i },
      { cat: "Keyboard", rx: /\bkeyboard\b|mechanical keyboard|wireless keyboard|magic keyboard|keychron|das keyboard/i },

      { cat: "3D Printer", rx: /3d printer|fdm printer|resin printer|sla printer|bambu\b|prusa\b|creality\b|anycubic\b/i },
      { cat: "Plotter", rx: /plotter|wide.?format printer|large.?format printer|hp designjet|epson surecolor/i },
      { cat: "Receipt Printer", rx: /receipt printer|thermal printer|pos printer|epson tm-|star micronics|citizen ct-/i },
      { cat: "Label Printer", rx: /label printer|zebra\b(?!.*scanner)|dymo\b|brother ql-|brother pt-|rollo\b|bixolon slp/i },
      { cat: "MFP / Copier", rx: /mfp\b|multifunction|all.in.one printer|copier|imagerunner|bizhub|konica minolta|ricoh im|sharp mx|xerox versalink|canon imageclass/i },
      { cat: "Printer", rx: /\bprinter\b|laserjet|officejet|pixma|workforce|deskjet|color laserjet|lj\s+pro/i },

      { cat: "Film Scanner", rx: /film scanner|slide scanner|negative scanner|plustek\b/i },
      { cat: "Document Scanner", rx: /document scanner|sheet.?fed scanner|adf scanner|fujitsu fi-|scansnap|canon dr-/i },
      { cat: "Scanner", rx: /\bscanner\b(?!.*barcode|.*network|.*security|.*port)|flatbed scanner/i },

      { cat: "Video Conferencing System", rx: /video conferencing|teams room|zoom room|cisco webex\b|poly studio|logitech rally|microsoft teams display|neat bar/i },
      { cat: "Conference Camera", rx: /conference cam|meeting room cam|huddly|logitech rally\s+camera|poly eagle eye|jabra panacast/i },
      { cat: "Capture Card", rx: /capture card|video capture|elgato\b|avermedia|magewell|blackmagic (decklink|intensity)/i },
      { cat: "Streaming Device", rx: /streaming device|chromecast|fire tv stick|apple tv|nvidia shield|roku\b/i },
      { cat: "Media Player", rx: /media player|digital media player|plex player|kodi box|iptv box/i },
      { cat: "Webcam", rx: /webcam|web camera|brio\b|c920|c922|c925|c930|logitech c\d{3}/i },
      { cat: "Audio Interface", rx: /audio interface|focusrite scarlett|scarlett solo|behringer umc|steinberg ur|presonus audiobox/i },
      { cat: "Soundbar", rx: /soundbar|sound bar|polk\b(?!.*speaker)|bose soundbar|samsung hw-/i },
      { cat: "Speaker", rx: /\bspeaker\b|computer speaker|desktop speaker|studio monitor|klipsch|jbl\b(?!.*headphone)|edifier/i },
      { cat: "Microphone", rx: /microphone|\bmic\b|condenser mic|usb mic|blue yeti|blue snowball|rode\b|shure\b(?!.*headset)/i },
      { cat: "Headphones", rx: /headphones|over.?ear|on.?ear|beats studio|sony wh-|bose qc|airpods max/i },
      { cat: "Headset", rx: /headset|jabra\b|plantronics|poly\b(?!.*studio|.*video)|sennheiser headset|logitech h\d{3}|gaming headset/i },

      { cat: "SD-WAN Appliance", rx: /sd-wan|sdwan|velocloud|silverpeak|viptela|meraki mx(?!.*switch)|fortinet sdwan/i },
      { cat: "VPN Concentrator", rx: /vpn concentrator|vpn gateway|cisco asa\b|palo alto\b(?!.*firewall)|vpn appliance/i },
      { cat: "Proxy Appliance", rx: /proxy appliance|web gateway|secure web gateway|bluecoat|zscaler appliance|squid proxy/i },
      { cat: "Network Analyzer", rx: /network analyzer|packet analyzer|protocol analyzer|wireshark appliance|lan analyzer|network probe/i },
      { cat: "Network Tap", rx: /network tap|passive tap|gigamon|ixia (tap|net tap)/i },
      { cat: "Load Balancer", rx: /load balancer|f5\b|big-ip|netscaler|citrix adc|kemp loadmaster|haproxy appliance/i },
      { cat: "Firewall", rx: /firewall|fortigate|palo alto firewall|watchguard|sophos\b(?!.*switch|.*ap)|checkpoint|cisco asa(?!.*vpn)|juniper srx|ngfw|utm\b/i },
      { cat: "Wireless AP", rx: /access point|wireless ap|\bwap\b|unifi ap|aironet|aruba ap|ruckus|ubiquiti\b(?!.*switch)|cisco air-|meraki mr\d/i },
      { cat: "Network Card / NIC", rx: /network card|\bnic\b|ethernet card|10gbe nic|25gbe nic|intel i350|broadcom bcm/i },
      { cat: "Bluetooth Adapter", rx: /bluetooth (adapter|dongle|receiver)|bt adapter|csr8510/i },
      { cat: "Wi-Fi Adapter", rx: /wi.?fi (adapter|dongle|card)|wireless (adapter|dongle|card)|usb wifi|alfa\b(?!.*laptop)/i },
      { cat: "Media Converter", rx: /media converter|fibre media converter|ethernet to fibre|planet fsd-/i },
      { cat: "Transceiver / SFP", rx: /transceiver|\bsfp\b|\bsfp\+\b|\bqsfp\b|fibre module|optical module|gbic\b/i },
      { cat: "Patch Panel", rx: /patch panel|keystone panel|24.port panel|48.port panel|structured cabling/i },
      { cat: "Network Modem", rx: /\bmodem\b|dsl modem|cable modem|adsl|vdsl|docsis|4g router|lte modem/i },
      { cat: "Router", rx: /\brouter\b(?!.*sd-wan)|wifi router|wireless router|nighthawk|archer\b|mikrotik\b|edgerouter|cisco isr|juniper mx|ubiquiti er/i },
      { cat: "Network Switch", rx: /\bswitch\b(?!.*kvm|.*hdmi|.*vga|.*power|.*poe strip)|catalyst\b|poe switch|gigabit switch|unifi switch|meraki ms|cisco sg\d|cisco ws-|aruba \d{4}|netgear gs|tp-link tl-sg|d-link dgs/i },

      { cat: "Biometric Lock", rx: /biometric lock|fingerprint lock|smart lock|electronic lock/i },
      { cat: "Security Key / Token", rx: /security key|hardware token|yubikey|fido key|u2f key|rsa token|smart card(?!.*reader)/i },
      { cat: "Intercom / Video Doorbell", rx: /intercom|video doorbell|door station|ring\b(?!.*network)|doorbell|aiphone/i },
      { cat: "Alarm System", rx: /alarm system|intruder alarm|motion detector|door sensor|window sensor|pir sensor/i },
      { cat: "Badge Reader", rx: /badge reader|proximity reader|hid reader|card access|door access reader/i },
      { cat: "NVR / DVR", rx: /\bnvr\b|\bdvr\b|network video recorder|digital video recorder|hikvision ds-7|dahua (xvr|nvr)/i },
      { cat: "IP Camera", rx: /ip camera|network camera|ptz camera|security camera|cctv camera|dome camera|bullet camera|hikvision ds-2|dahua ipc|axis\b(?!.*network switch)|bosch flexidome/i },
      { cat: "Access Control", rx: /access control|turnstile|door controller|electric strike|magnetic lock|keypad lock|entry system/i },

      { cat: "PBX / Phone System", rx: /pbx\b|phone system|3cx\b|avaya\b|cisco ucm|asterisk\b(?!.*board)|mitel\b|nec sv\d/i },
      { cat: "Conference Phone", rx: /conference phone|conference room phone|poly trio|yealink cp\d|cisco cp-88\d{2}|jabra speak/i },
      { cat: "Headset Base Station", rx: /headset base|charging base|bt base|dect base|jabra base|plantronics hub/i },
      { cat: "Walkie-Talkie", rx: /walkie.talkie|two.way radio|motorola dp\d|kenwood tk-|handheld radio/i },
      { cat: "Pager", rx: /\bpager\b|alphanumeric pager|numeric pager/i },
      { cat: "Desk Phone", rx: /desk phone|analog phone|office phone|sip phone(?!.*conference)|gigaset\b/i },
      { cat: "VoIP Phone", rx: /voip|ip phone|polycom vvx|yealink t\d{2}|cisco cp-\d{4}|grandstream gxp|snom\b/i },

      { cat: "ATS / Transfer Switch", rx: /\bats\b|automatic transfer switch|manual transfer switch|static transfer/i },
      { cat: "Generator", rx: /generator|diesel gen|petrol gen|standby generator/i },
      { cat: "PDU", rx: /\bpdu\b|power distribution unit|rack pdu|metered pdu|switched pdu|apc ap\d{4}|vertiv geist/i },
      { cat: "UPS", rx: /\bups\b|uninterruptible|back.?ups|smart.?ups|apc su\d|eaton 5p|cyberpower\b/i },
      { cat: "Surge Protector", rx: /surge protector|surge strip|spike guard/i },
      { cat: "Power Strip", rx: /power strip|extension lead|power board|multi-socket/i },

      { cat: "Docking Station", rx: /dock(ing station)?|thunderbolt dock|usb.c dock|usb hub dock|dell wd\d{2}|hp thunderbolt|lenovo thinkpad dock/i },
      { cat: "Port Replicator", rx: /port replicator|usb replicator|travel hub/i },
      { cat: "KVM Extender", rx: /kvm extender|hdmi extender|vga extender|cat5 extender|catx extender/i },
      { cat: "USB Hub", rx: /usb hub|usb splitter|usb concentrator|7.port usb|10.port usb/i },
      { cat: "Adapter / Dongle", rx: /adapter|dongle|converter plug|hdmi to vga|usb.c to hdmi|displayport adapter|vga adapter|dvi adapter|thunderbolt adapter|type.c adapter/i },
      { cat: "Fibre Cable", rx: /fibre (cable|patch|lead)|fiber (cable|patch|lead)|lc-lc|sc-lc|om3|om4|os2 cable/i },
      { cat: "Patch Cable", rx: /patch (cable|lead|cord)|cat5e|cat6\b|cat6a|cat7\b|rj45 cable|ethernet (cable|lead)/i },
      { cat: "HDMI / DisplayPort Cable", rx: /hdmi (cable|lead)|displayport (cable|lead)|dp cable|mini hdmi|micro hdmi/i },
      { cat: "USB Cable", rx: /usb (cable|lead|cord)|usb.c cable|micro usb|lightning (cable|lead)|usb 3\.0 cable/i },
      { cat: "Power Cable", rx: /power (cable|cord|lead)|iec (cable|lead)|c13 cable|c19 cable|kettle lead|cloverleaf cable/i },
      { cat: "Connector / Coupler", rx: /connector|coupler|keystone|rj45 (plug|coupler)|coupler\b/i },
      { cat: "Cable Management", rx: /cable management|cable tray|cable duct|velcro tie|cable tie|cable lacing|cable sleeve/i },
      { cat: "Cable", rx: /\bcable\b|\blead\b(?!\s*time)|wire\b(?!\s*less)/i },

      { cat: "Cooling Unit", rx: /crac\b|crah\b|in.row cooling|precision cooling|data center cooling|row cooling/i },
      { cat: "Blanking Panel", rx: /blanking panel|filler panel|blank panel|1u blank/i },
      { cat: "Rack Rail Kit", rx: /rail kit|rack rail|sliding rail|rack mount kit/i },
      { cat: "Rack Shelf", rx: /rack shelf|cantilever shelf|1u shelf|2u shelf/i },
      { cat: "Server Cabinet", rx: /server cabinet|network cabinet|floor standing cabinet|data cabinet/i },
      { cat: "Rack / Enclosure", rx: /\brack\b|enclosure|open frame rack|data center rack|42u|22u|12u|server rack/i },

      { cat: "Antivirus License", rx: /antivirus|anti-virus|endpoint protection|crowdstrike|sentinel(one)?|carbon black/i },
      { cat: "OS License", rx: /windows license|windows oem|windows coa|server license|cals?\b|rhel license|ubuntu advantage/i },
      { cat: "Software License", rx: /software license|software key|license key|product key|activation key|seat license/i },
      { cat: "Subscription / SaaS", rx: /subscription|saas\b|cloud license|microsoft 365|office 365|google workspace|azure subscription/i },
      { cat: "Hardware Warranty", rx: /warranty|extended warranty|support contract|care pack|nbd support|applecare/i },

      { cat: "Printer Drum", rx: /printer drum|drum unit|imaging drum|drum cartridge/i },
      { cat: "Toner Cartridge", rx: /toner cartridge|toner kit|toner refill|\btoner\b/i },
      { cat: "Ink Cartridge", rx: /ink cartridge|ink refill|inkjet cartridge|\bink\b(?=.*cartridge)/i },
      { cat: "Label Roll", rx: /label roll|label stock|thermal label|direct thermal|dymo label|zebra label/i },
      { cat: "Thermal Paper", rx: /thermal paper|receipt paper|till roll|pos paper/i },
      { cat: "Cleaning Kit", rx: /cleaning kit|screen cleaner|lens cleaner|compressed air|dust blower/i },
      { cat: "Battery Pack", rx: /battery pack|aa batteries|aaa batteries|rechargeable battery|cr\d{4}|18650 battery/i },

      { cat: "VR / AR Headset", rx: /vr headset|ar headset|virtual reality|augmented reality|oculus|meta quest|hololens|valve index/i },
      { cat: "Smart TV", rx: /smart tv|android tv|webos tv|samsung qled|lg oled|sony bravia|hisense u\d/i },
      { cat: "Set-Top Box", rx: /set.top box|stb\b|cable box|satellite box|sky box|freeview box|apple tv(?!.*streaming)/i },
      { cat: "IoT Device", rx: /iot\b|internet of things|smart sensor|connected device|zigbee|z.wave|smart plug|smart bulb/i },
      { cat: "Smart Hub", rx: /smart hub|home hub|iot hub|samsung smartthings|philips hue hub|vera\b|homey\b/i },
      { cat: "Environmental Monitor", rx: /environmental monitor|temperature sensor|humidity sensor|data logger|sensor probe|apc nb\d{3}|netbotz/i },
      { cat: "Antenna", rx: /\bantenna\b|aerial\b|omni antenna|yagi antenna|sector antenna|wifi antenna/i },
      { cat: "Satellite Equipment", rx: /satellite|vsat\b|dish\b(?=.*satellite)|satellite modem|satcom/i },
      { cat: "Drone", rx: /\bdrone\b|uav\b|quadcopter|dji\b|parrot\b(?!.*headset)/i },
      { cat: "3D Scanner", rx: /3d scanner|3d scanning|structured light scanner|artec\b|faro\b(?!.*switch)/i },
      { cat: "Kiosk", rx: /\bkiosk\b|self.service terminal|interactive kiosk|information kiosk/i },
      { cat: "POS Terminal", rx: /pos terminal|point of sale|pos system|cash register|till system|verifone|ingenico/i },
      { cat: "Industrial PC", rx: /industrial pc|panel pc|din rail pc|fanless pc|embedded pc|automation controller/i },
      { cat: "Embedded System", rx: /embedded system|embedded module|system on module|som\b|com express|smarc\b/i },
      { cat: "Raspberry Pi / SBC", rx: /raspberry pi|pi zero|pi \d|rock pi|orange pi|banana pi|jetson nano|odroid|single board/i },
      { cat: "Arduino / Microcontroller", rx: /arduino|microcontroller|esp32|esp8266|stm32|avr\b|pic\b(?=.*microcontroller)/i },

      { cat: "IT Equipment", rx: /it equipment|it asset|technology|computing|electronic/i }

    ];
    function classifyCategory(n, b, r) {
      const s = (n + " " + b + " " + (r || "")).toLowerCase();
      for (const x of CR) { if (x.rx.test(s)) return x.cat; }
      return "MISC";
    }

    function extractProductData(raw, src) {
      let product = "", brand = "", model = "", rawCat = "";
      if (src === "openfoodfacts") { product = raw.product_name || raw.product_name_en || ""; brand = raw.brands ? raw.brands.split(",")[0].trim() : ""; rawCat = raw.categories || ""; }
      if (src === "upcitemdb") { product = raw.title || ""; brand = raw.brand || ""; model = raw.model || ""; rawCat = raw.category || ""; if (!model && raw.description) { const m = raw.description.match(/model[:\s#]+([A-Z0-9\-]{3,20})/i); if (m) model = m[1]; } }
      if (brand && product && !product.toLowerCase().includes(brand.toLowerCase())) product = brand + " " + product;
      if (!model && product) { for (const t of product.split(/\s+/)) { if (/^[A-Z]{1,4}[-]?\d{3,}[A-Z0-9\-]*$/i.test(t) && t.length >= 4) { model = t; break; } } if (!model) model = brand || ""; }
      return { product: product.trim(), model: model.trim(), brand: brand.trim(), category: classifyCategory(product, brand, rawCat) };
    }

    function autoFillSerial(val) { const el = document.getElementById("serial"); if (!el.dataset.manual) { el.value = val.trim(); el.classList.toggle("filled", !!(val.trim())); } }

    async function lookupBarcode() {
      const bc = document.getElementById("barcode").value.trim();
      if (!bc) { showToast("Enter a barcode first.", "warn"); return; }

      if (inventory[bc]) {
        fillFields(inventory[bc]);
        const qtyInfo = inventory[bc].qty > 0 ? " (" + inventory[bc].qty + " in stock)" : " (Out of stock)";
        setStatus("‚úì Loaded from inventory: " + inventory[bc].product + qtyInfo);
        showToast("‚úì Found in inventory" + qtyInfo);
        document.getElementById("sourceTag").style.display = "block";
        document.getElementById("sourceLabel").textContent = "Local Inventory";
        document.getElementById("catLabel").textContent = inventory[bc].category || "IT Equipment";
        return;
      }

      const archivedItem = archive.find(a => a.barcode === bc && a.status === "Out of Stock");
      if (archivedItem) {
        fillFields({
          product: archivedItem.product,
          model: archivedItem.model || "",
          category: archivedItem.category || "IT Equipment",
          location: archivedItem.location || "IT Office"
        });
        setStatus("‚ö†Ô∏è NO STOCK AVAILABLE - Item in archive (depleted)");
        showToast("‚ö†Ô∏è No stock available - archived item", "warn");
        document.getElementById("sourceTag").style.display = "block";
        document.getElementById("sourceLabel").textContent = "Archive (No Stock)";
        document.getElementById("catLabel").textContent = archivedItem.category || "IT Equipment";
        return;
      }

      showLookup(true); setStatus("Querying databases for: " + bc + "...");
      let result = null;
      try { const r = await fetch("https://api.upcitemdb.com/prod/trial/lookup?upc=" + encodeURIComponent(bc)); if (r.ok) { const d = await r.json(); if (d.code === "OK" && d.items?.length > 0 && d.items[0].title) { result = extractProductData(d.items[0], "upcitemdb"); result.source = "UPC ItemDB"; } } } catch (e) { }
      if (!result) { try { const r = await fetch("https://world.openfoodfacts.org/api/v0/product/" + encodeURIComponent(bc) + ".json"); if (r.ok) { const d = await r.json(); if (d.status === 1 && d.product) { const pn = d.product.product_name || d.product.product_name_en || ""; if (pn && pn.length > 2) { result = extractProductData(d.product, "openfoodfacts"); result.source = "Open Product DB"; } } } } catch (e) { } }
      showLookup(false);
      if (result && result.product) { fillFields(result); document.getElementById("sourceTag").style.display = "block"; document.getElementById("sourceLabel").textContent = result.source; document.getElementById("catLabel").textContent = result.category; setStatus("Found via " + result.source + ": " + result.product + " [" + result.category + "]"); showToast(result.product + " [" + result.category + "]"); }
      else { fillFields({ product: "IT Device " + bc.slice(-4).toUpperCase(), model: "", category: "MISC" }); document.getElementById("sourceTag").style.display = "block"; document.getElementById("sourceLabel").textContent = "None - manual entry"; document.getElementById("catLabel").textContent = "MISC"; setStatus("Not found online - fill in manually."); showToast("Not found online - fill in manually.", "warn"); }
    }

    function fillFields(item) {
      const set = (id, val) => { const el = document.getElementById(id); if (!el) return; if (el.tagName === "SELECT") { if (val && !Array.from(el.options).some(o => o.value === val)) { const opt = document.createElement("option"); opt.value = val; opt.textContent = val; el.appendChild(opt); } el.value = val || ""; } else { el.value = val || ""; } el.classList.toggle("filled", !!(val)); };
      set("productName", item.product || ""); set("model", item.model || item.brand || ""); set("category", item.category || ""); if (item.location) set("location", item.location);

      selectCatOption(item.category || "");
    }

    function processScan() {

      const btn = document.getElementById("submitBtn");
      btn.style.transform = "scale(0.95)";
      setTimeout(() => btn.style.transform = "", 100);

      const bc = document.getElementById("barcode").value.trim();
      const prod = document.getElementById("productName").value.trim();
      const mdl = document.getElementById("model").value.trim();
      const cat = document.getElementById("category").value.trim();
      const loc = document.getElementById("location").value.trim() || "IT Office";
      const ser = document.getElementById("serial").value.trim();
      const dir = document.getElementById("direction").value;
      const qty = parseInt(document.getElementById("quantity").value) || 1;
      if (!bc && dir !== "E-WASTE") { showToast("Barcode is required.", "error"); return; }
      if (!prod) { showToast("Enter a product name.", "warn"); return; }

      if (dir === "E-WASTE") {

        const itemInStock = bc && inventory[bc];
        if (itemInStock) {

          inventory[bc].qty = Math.max(0, inventory[bc].qty - qty);
          if (inventory[bc].qty <= 0) delete inventory[bc];
        }

        const ewId = bc || ("EWASTE-" + Date.now());
        archive.unshift({
          time: new Date().toLocaleString(), barcode: ewId,
          product: prod, model: mdl, category: cat || "IT Equipment",
          qty, location: loc, status: "E-Waste"
        });
        transactions.unshift({ time: new Date().toLocaleString(), barcode: ewId, product: prod, serial: ser, direction: "E-WASTE", qty, category: cat || "IT Equipment" });
        persist();
        setStatus("‚ôª E-WASTE: " + qty + "x " + prod + (bc ? " [" + bc + "]" : ""));
        showToast("‚ôª E-Waste logged: " + qty + "x " + prod, "warn");
        clearForm();
        requestAnimationFrame(() => { refreshAll(); saveInventoryToFolder().catch(e => console.warn(e)); });
        return;
      }

      if (!bc) { showToast("Barcode is required.", "error"); return; }
      if (dir === "OUT") { const cur = inventory[bc] ? inventory[bc].qty : 0; if (qty > cur) { showStockModal(prod, cur, qty); return; } }
      if (!inventory[bc]) inventory[bc] = { barcode: bc, product: prod, model: mdl, category: cat, location: loc, qty: 0 };
      else Object.assign(inventory[bc], { product: prod, model: mdl, category: cat, location: loc });

      if (dir === "IN") inventory[bc].qty += qty;
      else {
        inventory[bc].qty -= qty;
        archive.unshift({ time: new Date().toLocaleString(), barcode: bc, product: prod, model: mdl, category: cat, qty, location: loc, status: "Checked Out" });
      }

      if (inventory[bc] && inventory[bc].qty <= 0) {
        const archivedData = {
          time: new Date().toLocaleString(),
          barcode: bc, product: prod, model: mdl, category: cat, location: loc,
          qty: 0, archivedQty: Math.abs(inventory[bc].qty), status: "Out of Stock"
        };
        const existingIndex = archive.findIndex(a => a.barcode === bc && a.status === "Out of Stock");
        if (existingIndex >= 0) archive[existingIndex] = archivedData;
        else archive.unshift(archivedData);
        const itemToArchive = { ...inventory[bc], archivedAt: new Date().toISOString() };
        archiveProduct(itemToArchive).catch(e => console.warn("Archive failed:", e));
        delete inventory[bc];
        showToast("‚ö†Ô∏è Product depleted - moved to archive: " + prod, "warn");
      }

      transactions.unshift({ time: new Date().toLocaleString(), barcode: bc, product: prod, serial: ser, direction: dir, qty, category: cat || "IT Equipment" });

      persist();

      setStatus(dir + " " + qty + "x " + prod);
      showToast(dir + ": " + qty + "x " + prod, dir === "IN" ? "success" : "warn");

      clearForm();

      requestAnimationFrame(() => {
        refreshAll();

        saveInventoryToFolder().catch(e => console.warn("Background save failed:", e));
      });
    }

    function toggleCamera() {
      const re = document.getElementById("reader");
      if (scannerActive) { html5Scanner.stop().then(() => { re.style.display = "none"; scannerActive = false; setStatus("Camera stopped."); }).catch(() => { }); return; }
      re.style.display = "block"; html5Scanner = new Html5Qrcode("reader");
      html5Scanner.start({ facingMode: "environment" }, { fps: 12, qrbox: { width: 260, height: 160 } },
        code => { document.getElementById("barcode").value = code; autoFillSerial(code); html5Scanner.stop().then(() => { re.style.display = "none"; scannerActive = false; lookupBarcode(); }).catch(() => { }); }, () => { }
      ).then(() => { scannerActive = true; setStatus("Camera active - point at barcode."); }).catch(err => { showToast("Camera error: " + err, "error"); re.style.display = "none"; });
    }

    function onDirectionChange(dir) {
      const barcodeInput = document.getElementById("barcode");
      const barcodeLabel = barcodeInput ? barcodeInput.closest(".field-group") : null;
      const lookupBtn = document.querySelector(".barcode-row .btn-primary");
      const submitBtn = document.getElementById("submitBtn");
      if (dir === "E-WASTE") {
        if (barcodeInput) { barcodeInput.placeholder = "Optional ‚Äî scan or type if known"; }
        if (submitBtn) { submitBtn.style.background = "linear-gradient(135deg,#a855f7,#7c3aed)"; submitBtn.style.boxShadow = "0 4px 16px rgba(168,85,247,0.4)"; submitBtn.textContent = "‚ôª Log E-Waste"; }
        setStatus("‚ôª E-Waste mode ‚Äî barcode is optional. Enter product name and submit.");
      } else {
        if (barcodeInput) { barcodeInput.placeholder = "Scan or type barcode..."; }
        if (submitBtn) { submitBtn.style.background = ""; submitBtn.style.boxShadow = ""; submitBtn.innerHTML = "&#10003; Submit Transaction"; }
        setStatus("Ready.");
      }
    }

    const CAT_PICKER_LIST = [
      '3D Printer', '3D Scanner', 'Access Control', 'Access Point', 'Adapter / Dongle', 'Alarm System', 'All-in-One PC',
      'Antenna', 'Antivirus License', 'Arduino / Microcontroller', 'ATS / Transfer Switch', 'Audio Interface',
      'Badge Reader', 'Barcode Scanner', 'Battery / CMOS', 'Battery Pack', 'Biometric Lock', 'Biometric Scanner',
      'Blade Server', 'Blanking Panel', 'Bluetooth Adapter', 'Cable', 'Cable Management', 'Capture Card',
      'Card Reader', 'Charger', 'Chromebook', 'Cleaning Kit', 'Computer', 'Conference Camera', 'Conference Phone',
      'Connector / Coupler', 'Cooling / Fan', 'Cooling Unit', 'CPU / Processor', 'Desk Phone', 'Desktop',
      'Digital Signage', 'Display Port Splitter', 'Docking Station', 'Document Scanner', 'Drone',
      'Embedded System', 'Environmental Monitor', 'Expansion Card', 'Fibre Cable', 'Film Scanner', 'Firewall',
      'Generator', 'GPU / Graphics', 'GPU/PSU', 'Graphics Tablet', 'Hard Drive', 'Hardware Warranty',
      'HDMI / DisplayPort Cable', 'Headphones', 'Headset', 'Headset Base Station', 'Industrial PC',
      'Ink Cartridge', 'Intercom / Video Doorbell', 'IoT Device', 'IP Camera', 'IT Equipment', 'Keyboard',
      'Kiosk', 'KVM Extender', 'KVM over IP', 'KVM Switch', 'Label Printer', 'Label Roll', 'Laptop',
      'Load Balancer', 'Media Converter', 'Media Player', 'MFP / Copier', 'Micro PC / NUC', 'Microphone',
      'Mini PC', 'MISC', 'Monitor', 'Motherboard', 'Mouse', 'NAS', 'Network Analyzer', 'Network Card / NIC',
      'Network Modem', 'Network Switch', 'Network Tap', 'Networking', 'NVMe Drive', 'NVR / DVR', 'Optical Drive',
      'OS License', 'Pager', 'Patch Cable', 'Patch Panel', 'PBX / Phone System', 'PDU', 'Peripheral', 'Phone',
      'Phone Base', 'PoE', 'Plotter', 'Port Replicator', 'POS Terminal', 'Power Cable', 'Power Strip', 'Power Supply',
      'Printer', 'Printer Drum', 'Projector', 'Proxy Appliance', 'Rack / Enclosure', 'Rack Rail Kit', 'Rack Shelf',
      'RAID Controller', 'RAM / Memory', 'Raspberry Pi / SBC', 'Receipt Printer', 'RFID Reader', 'Router',
      'Rugged Device', 'SAN', 'Satellite Equipment', 'Scanner', 'SD Card', 'SD-WAN Appliance',
      'Security Key / Token', 'Server', 'Server Cabinet', 'Set-Top Box', 'Signature Pad', 'Smart Card Reader',
      'Smart Hub', 'Smart TV', 'Smartphone', 'Software License', 'Sound Card', 'Soundbar', 'Speaker', 'SSD',
      'Storage Array', 'Streaming Device', 'Subscription / SaaS', 'Surge Protector', 'Tablet', 'Tape Drive',
      'Thermal Paper', 'Thin Client', 'Toner Cartridge', 'Trackpad / Trackball', 'Transceiver / SFP', 'UPS',
      'USB Cable', 'USB Drive', 'USB Hub', 'Video Conferencing System', 'Video Wall Controller', 'VoIP Phone',
      'VPN Concentrator', 'VR / AR Headset', 'Walkie-Talkie', 'Wearable', 'Webcam', 'Wi-Fi Adapter',
      'Wireless AP', 'Workstation'
    ];

    let _catPickerValue = '';
    let _catDropdownOpen = false;

    function initCatPicker() {
      const list = document.getElementById('catList');
      if (!list) return;

      const sel = document.getElementById('category');
      if (sel) {
        sel.innerHTML = '<option value="">-- Select --</option>' +
          CAT_PICKER_LIST.map(c => '<option value="' + c + '">' + c + '</option>').join('');
      }
      renderCatOptions('');

      document.addEventListener('click', function (e) {
        const wrap = document.getElementById('catPickerWrap');
        if (wrap && !wrap.contains(e.target)) closeCatDropdown();
      });
    }

    function renderCatOptions(q) {
      const list = document.getElementById('catList');
      if (!list) return;
      const lq = q.toLowerCase();
      const filtered = q ? CAT_PICKER_LIST.filter(c => c.toLowerCase().includes(lq)) : CAT_PICKER_LIST;
      if (!filtered.length) {
        list.innerHTML = '<div class="cat-no-results">No categories match "' + esc2(q) + '"</div>';
        return;
      }
      list.innerHTML = filtered.map(c =>
        '<div class="cat-opt' + (c === _catPickerValue ? ' selected' : '') +
        '" onclick="selectCatOption(\'' + esc2(c) + '\')"><span class="cat-opt-dot"></span>' + esc2(c) + '</div>'
      ).join('');
    }

    function esc2(s) { return (s || '').replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/</g, '&lt;'); }

    function filterCatOptions(q) {
      renderCatOptions(q);

      const sel = document.querySelector('.cat-opt.selected');
      if (sel) sel.scrollIntoView({ block: 'nearest' });
    }

    function toggleCatDropdown() {
      if (_catDropdownOpen) closeCatDropdown();
      else openCatDropdown();
    }

    function openCatDropdown() {
      const dd = document.getElementById('catDropdown');
      const btn = document.getElementById('catDisplayBtn');
      const inp = document.getElementById('catSearchInput');
      if (dd) { dd.classList.add('open'); _catDropdownOpen = true; }
      if (btn) { btn.classList.add('open'); }
      if (inp) { inp.value = ''; inp.focus(); renderCatOptions(''); }

      setTimeout(() => { const s = document.querySelector('.cat-opt.selected'); if (s) s.scrollIntoView({ block: 'center' }); }, 50);
    }

    function closeCatDropdown() {
      const dd = document.getElementById('catDropdown');
      const btn = document.getElementById('catDisplayBtn');
      if (dd) { dd.classList.remove('open'); _catDropdownOpen = false; }
      if (btn) { btn.classList.remove('open'); }
    }

    function selectCatOption(val) {
      _catPickerValue = val;
      const txt = document.getElementById('catDisplayText');
      const btn = document.getElementById('catDisplayBtn');
      const sel = document.getElementById('category');
      if (txt) {
        txt.textContent = val || '-- Select or auto-filled --';
        txt.classList.toggle('placeholder', !val);
      }
      if (btn) btn.classList.toggle('filled', !!val);
      if (sel) sel.value = val || '';
      closeCatDropdown();

      const inp = document.getElementById('catSearchInput');
      renderCatOptions(inp ? inp.value : '');
    }

    function onCategoryChange(val) {
      selectCatOption(val);
    }

    function showCatSearch() { }
    function hideCatSearch() { }
    function filterCategories(q) { renderCatOptions(q); }

    function clearForm() {
      ["barcode", "productName", "model", "serial"].forEach(id => { const el = document.getElementById(id); if (el) { el.value = ""; el.classList.remove("filled"); } });
      const cat = document.getElementById("category"); if (cat) { cat.value = ""; cat.classList.remove("filled"); }
      const cb = document.getElementById("catBadge"); if (cb) cb.classList.remove("show");
      selectCatOption('');
      document.getElementById("quantity").value = 1;
      const se = document.getElementById("serial"); if (se) se.dataset.manual = "";
      const dir = document.getElementById("direction"); if (dir) { dir.value = "IN"; onDirectionChange("IN"); }
      document.getElementById("barcode").focus();
      const st = document.getElementById("sourceTag"); if (st) st.style.display = "none";
    }

    async function exportPDF() {
      const items = Object.values(inventory);
      if (!items.length) { showToast("No inventory data to export.", "warn"); return; }
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
        const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();
        doc.setFillColor(9, 13, 19); doc.rect(0, 0, W, H, "F");
        doc.setFillColor(0, 180, 220); doc.rect(0, 0, W, 20, "F");
        doc.setTextColor(9, 13, 19); doc.setFont("helvetica", "bold"); doc.setFontSize(13);
        doc.text("IT-INVENTORY REPORT", 14, 13);
        doc.setFontSize(8); doc.text("Exported: " + new Date().toLocaleString() + "   |   User: " + (currentUser || "").toUpperCase(), W - 14, 13, { align: "right" });
        doc.setTextColor(100, 160, 180); doc.setFont("helvetica", "normal"); doc.setFontSize(8);
        doc.text("Total SKUs: " + items.length + "   |   Total Units: " + items.reduce((a, i) => a + i.qty, 0), 14, 27);
        doc.autoTable({
          startY: 30, head: [["Barcode", "Product Name", "Model / Brand", "Category", "Qty", "Location"]],
          body: items.map(i => [i.barcode, i.product, i.model || "--", i.category || "--", String(i.qty), i.location]),
          styles: { font: "helvetica", fontSize: 9, cellPadding: 4, fillColor: [17, 24, 39], textColor: [205, 217, 229], lineColor: [26, 48, 64], lineWidth: 0.3 },
          headStyles: { fillColor: [0, 180, 220], textColor: [9, 13, 19], fontStyle: "bold", fontSize: 9 },
          alternateRowStyles: { fillColor: [12, 22, 32] }, columnStyles: { 4: { halign: "center", textColor: [0, 220, 120] } }, margin: { left: 14, right: 14 }
        });
        const pages = doc.internal.getNumberOfPages();
        for (let p = 1; p <= pages; p++) { doc.setPage(p); doc.setFillColor(14, 22, 32); doc.rect(0, H - 10, W, 10, "F"); doc.setTextColor(74, 96, 112); doc.setFontSize(7); doc.text("it-inventory  |  CONFIDENTIAL", 14, H - 3); doc.text("Page " + p + " / " + pages, W - 14, H - 3, { align: "right" }); }
        const ts = new Date().toISOString().slice(0, 10) + "_" + new Date().toTimeString().slice(0, 8).replace(/:/g, "-");
        const filename = "IT_Inventory_Export_" + ts + ".pdf";
        const blob = doc.output("blob");

        const count = items.length;
        const totalUnits = items.reduce((a, i) => a + i.qty, 0);

        const savedToFolder = await writeToFolder(inventoryFolderHandle, blob, filename);

        if (!savedToFolder) {

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        if (savedToFolder) {
          showToast("‚úì Exported " + count + " items (" + totalUnits + " units) to PDF");
          setStatus("‚úì PDF saved to folder (" + count + " items)");
        } else {
          showToast("‚úì PDF downloaded (" + count + " items)");
          setStatus("Downloaded PDF with " + count + " items.");
        }
      } catch (err) { console.error(err); showToast("Export failed: " + err.message, "error"); }
    }

    async function exportTransactionsPDF(forDate) {
      if (!transactions.length) {
        showToast("No transactions to export.", "warn");
        return false;
      }
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
        const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();

        doc.setFillColor(9, 13, 19); doc.rect(0, 0, W, H, "F");
        doc.setFillColor(0, 180, 220); doc.rect(0, 0, W, 20, "F");
        doc.setTextColor(9, 13, 19); doc.setFont("helvetica", "bold"); doc.setFontSize(13);
        doc.text("IT-INVENTORY ‚Äî DAILY LOG", 14, 13);
        doc.setFontSize(8);
        doc.text("Date: " + forDate + "   |   User: " + (currentUser || "").toUpperCase() + "   |   Total Transactions: " + transactions.length, W - 14, 13, { align: "right" });

        const inCount = transactions.filter(t => t.direction === "IN").length;
        const outCount = transactions.filter(t => t.direction === "OUT").length;
        const ewasteCount = transactions.filter(t => t.direction === "E-WASTE").length;
        doc.setTextColor(100, 160, 180); doc.setFont("helvetica", "normal"); doc.setFontSize(8);
        doc.text("Check-INs: " + inCount + "   |   Check-OUTs: " + outCount + "   |   E-Waste: " + ewasteCount, 14, 27);

        doc.autoTable({
          startY: 30,
          head: [["Time", "Barcode", "Product", "Serial", "Direction", "Qty"]],
          body: transactions.map(t => [
            t.time, t.barcode, t.product || "--", t.serial || "--",
            t.direction, String(t.qty)
          ]),
          styles: { font: "helvetica", fontSize: 9, cellPadding: 4, fillColor: [17, 24, 39], textColor: [205, 217, 229], lineColor: [26, 48, 64], lineWidth: 0.3 },
          headStyles: { fillColor: [0, 180, 220], textColor: [9, 13, 19], fontStyle: "bold", fontSize: 9 },
          alternateRowStyles: { fillColor: [12, 22, 32] },
          columnStyles: {
            4: { halign: "center", fontStyle: "bold" },
            5: { halign: "center", textColor: [0, 220, 120] }
          },
          didParseCell: function (data) {
            if (data.column.index === 4 && data.section === "body") {
              if (data.cell.raw === "IN") data.cell.styles.textColor = [0, 255, 136];
              else if (data.cell.raw === "E-WASTE") data.cell.styles.textColor = [168, 85, 247];
              else data.cell.styles.textColor = [255, 51, 85];
            }
          },
          margin: { left: 14, right: 14 }
        });

        const pages = doc.internal.getNumberOfPages();
        for (let p = 1; p <= pages; p++) {
          doc.setPage(p);
          doc.setFillColor(14, 22, 32); doc.rect(0, H - 10, W, 10, "F");
          doc.setTextColor(74, 96, 112); doc.setFontSize(7);
          doc.text("it-inventory  |  CONFIDENTIAL", 14, H - 3);
          doc.text("Page " + p + " / " + pages, W - 14, H - 3, { align: "right" });
        }

        const blob = doc.output("blob");

        const safeDate = forDate.replace(/[/\\:*?"<>|]/g, "-");
        const filename = safeDate + ".pdf";

        let saved = false;
        if (transactionsFolderHandle) {
          saved = await writeToFolder(transactionsFolderHandle, blob, filename);
        }
        if (!saved) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href = url; a.download = filename;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }
        return true;
      } catch (err) {
        console.error("Transaction PDF export failed:", err);
        showToast("Transaction export failed: " + err.message, "error");
        return false;
      }
    }

    async function dailyTransactionRollover() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      const dateStr = dd + "/" + mm + "/" + yyyy;

      if (!transactions.length) {

        localStorage.setItem("itinv_last_rollover", dateStr);
        return;
      }

      setStatus("‚è≥ End-of-day rollover ‚Äî exporting transactions...");
      const ok = await exportTransactionsPDF(dateStr);
      if (ok) {

        pushTransactionsToHistory(dateStr);
        transactions = [];
        persist();
        refreshAll();
        localStorage.setItem("itinv_last_rollover", dateStr);
        showToast("‚úì Transactions saved to history & cleared for new day", "warn");
        setStatus("‚úì Daily rollover complete ‚Äî transactions archived for " + dateStr);
      }
    }

    async function manualExportTransactions() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      const dateStr = dd + "/" + mm + "/" + yyyy;
      const ok = await exportTransactionsPDF(dateStr);
      if (ok) {
        pushTransactionsToHistory(dateStr);
        transactions = [];
        persist();
        refreshAll();
        showToast("‚úì Transactions exported & cleared", "warn");
        setStatus("‚úì Transactions exported to PDF and cleared");
      }
    }

    function pushTransactionsToHistory(dateStr) {
      try {
        const existing = JSON.parse(localStorage.getItem("itinv_all_transactions") || "[]");
        const stamped = transactions.map(t => ({
          date: dateStr,
          time: t.time,
          barcode: t.barcode,
          product: t.product,
          serial: t.serial || "",
          category: t.category || "IT Equipment",
          direction: t.direction,
          qty: t.qty
        }));
        const merged = stamped.concat(existing);
        localStorage.setItem("itinv_all_transactions", JSON.stringify(merged));
        localStorage.setItem("itinv_tx_last_push", new Date().toLocaleString());
      } catch (e) { console.warn("Failed to push to it-transactions:", e); }
    }

    function scheduleMidnightRollover() {
      const now = new Date();
      const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 5);
      const msUntilMidnight = midnight - now;
      setTimeout(async () => {
        await dailyTransactionRollover();
        scheduleMidnightRollover();
      }, msUntilMidnight);
      console.log("‚è∞ Transaction rollover scheduled in " + Math.round(msUntilMidnight / 1000 / 60) + " minutes");
    }

    (function checkMissedRollover() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      const todayStr = dd + "/" + mm + "/" + yyyy;
      const lastRollover = localStorage.getItem("itinv_last_rollover");
      if (lastRollover && lastRollover !== todayStr && transactions.length) {

        setTimeout(() => {
          dailyTransactionRollover();
        }, 3000);
      }
    })();

    scheduleMidnightRollover();

    function clearAllInventory() {
      const items = Object.values(inventory);
      if (!items.length) { showToast("Inventory is already empty.", "warn"); return; }
      const totalUnits = items.reduce((a, i) => a + i.qty, 0);
      document.getElementById('clearAllModalMsg').innerHTML =
        'You are about to permanently delete<br><span style="color:var(--red);font-size:18px;font-weight:700;">' + items.length + ' items</span> &nbsp;¬∑&nbsp; <span style="color:var(--red);font-size:18px;font-weight:700;">' + totalUnits + ' total units</span><br><br>All data will be archived before deletion.';
      document.getElementById('clearAllStep1').style.display = 'block';
      document.getElementById('clearAllStep2').style.display = 'none';
      document.getElementById('clearAllPassword').value = '';
      document.getElementById('clearAllPassError').style.display = 'none';
      document.getElementById('clearAllModal').classList.add('show');
    }

    function closeClearAllModal() {
      document.getElementById('clearAllModal').classList.remove('show');
    }

    function clearAllStep2() {
      document.getElementById('clearAllStep1').style.display = 'none';
      document.getElementById('clearAllStep2').style.display = 'block';
      setTimeout(() => document.getElementById('clearAllPassword').focus(), 100);
    }

    document.getElementById('clearAllModal').addEventListener('click', function (e) { if (e.target === this) closeClearAllModal(); });

    async function clearAllStep3() {
      const password = document.getElementById('clearAllPassword').value;
      const errEl = document.getElementById('clearAllPassError');
      if (!password) { errEl.style.display = 'block'; errEl.textContent = '‚ùå Password is required'; return; }
      if (!currentUser || !USERS[currentUser] || USERS[currentUser].password !== password) {
        errEl.style.display = 'block'; errEl.textContent = '‚ùå Incorrect password';
        document.getElementById('clearAllPassword').value = '';
        document.getElementById('clearAllPassword').focus();
        return;
      }
      closeClearAllModal();
      const items = Object.values(inventory);
      const totalUnits = items.reduce((a, i) => a + i.qty, 0);
      try {
        const archiveData = { clearedAt: new Date().toISOString(), clearedBy: currentUser, itemCount: items.length, totalUnits, items };
        const archiveBlob = new Blob([JSON.stringify(archiveData, null, 2)], { type: "application/json" });
        const archiveTs = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
        await writeToFolder(archiveFolderHandle, archiveBlob, "cleared_inventory_" + archiveTs + ".json");
        inventory = {}; transactions = [];
        persist();
        if (inventoryFolderHandle) {
          const emptyData = { savedAt: new Date().toISOString(), user: currentUser || "unknown", inventory: {}, transactions: [], note: "Inventory cleared by " + currentUser + " at " + new Date().toLocaleString() };
          const emptyBlob = new Blob([JSON.stringify(emptyData, null, 2)], { type: "application/json" });
          const emptyTs = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
          await writeToFolder(inventoryFolderHandle, emptyBlob, "inventory_" + emptyTs + ".json");
        }
        refreshAll();
        showDeleteAllToast(items.length, totalUnits);
        setStatus("‚ö† Inventory cleared by " + currentUser + " ‚Äî " + items.length + " items archived");
      } catch (err) { console.error(err); showToast("Clear failed: " + err.message, "error"); }
    }

    let _pendingDeleteBarcode = null;

    function deleteSingleItem(barcode) {
      const item = inventory[barcode];
      if (!item) { showToast("Item not found.", "error"); return; }
      _pendingDeleteBarcode = barcode;
      document.getElementById('deleteModalProduct').textContent = item.product || 'Unknown';
      document.getElementById('deleteModalBarcode').textContent = 'Barcode: ' + barcode;
      document.getElementById('deleteModalMeta').textContent =
        'Category: ' + (item.category || 'IT Equipment') + '  ¬∑  Qty: ' + item.qty + '  ¬∑  ' + (item.location || 'IT Office');
      document.getElementById('deleteModalPassword').value = '';
      document.getElementById('deleteModalPassError').style.display = 'none';
      document.getElementById('deleteModal').classList.add('show');
      setTimeout(() => document.getElementById('deleteModalPassword').focus(), 100);
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      document.getElementById('deleteModalPassword').value = '';
      document.getElementById('deleteModalPassError').style.display = 'none';
      _pendingDeleteBarcode = null;
    }

    document.getElementById('deleteModal').addEventListener('click', function (e) { if (e.target === this) closeDeleteModal(); });

    document.getElementById('deleteModalConfirmBtn').addEventListener('click', async function () {
      const barcode = _pendingDeleteBarcode;
      if (!barcode) { closeDeleteModal(); return; }
      const item = inventory[barcode];
      if (!item) { closeDeleteModal(); return; }

      const pass = document.getElementById('deleteModalPassword').value;
      const errEl = document.getElementById('deleteModalPassError');
      if (!pass) { errEl.style.display = 'block'; errEl.textContent = '‚ùå Password is required'; return; }
      if (!currentUser || !USERS[currentUser] || USERS[currentUser].password !== pass) {
        errEl.style.display = 'block'; errEl.textContent = '‚ùå Incorrect password';
        document.getElementById('deleteModalPassword').value = '';
        document.getElementById('deleteModalPassword').focus();
        return;
      }

      closeDeleteModal();
      const deletedData = {
        deletedAt: new Date().toISOString(),
        user: currentUser || "unknown",
        barcode: item.barcode,
        product: item.product,
        model: item.model || "",
        category: item.category || "IT Equipment",
        location: item.location || "IT Office",
        finalQty: item.qty,
        status: "DELETED - Manually removed from inventory",
        note: "This item can no longer be accessed. To re-add, scan barcode and check IN new stock."
      };
      const blob = new Blob([JSON.stringify(deletedData, null, 2)], { type: "application/json" });
      const fileTs = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
      await writeToFolder(archiveFolderHandle, blob, "deleted_" + barcode + "_" + fileTs + ".json").catch(() => { });
      delete inventory[barcode];
      persist();
      refreshAll();
      showToast(item.product, "delete-single");
      setStatus("Deleted item " + barcode + " ‚Äî " + item.product);
    });

    function handleFileDrop(e) { e.preventDefault(); document.getElementById("importZone").classList.remove("drag-over"); handleImportFiles(e.dataTransfer.files); }

    let stagedItems = [];

    async function handleImportFiles(files) {
      if (!files || !files.length) return;
      const log = document.getElementById("importLog");
      log.innerHTML = "";
      stagedItems = [];
      hidePreview();

      for (const file of Array.from(files)) {
        const fname = file.name.toLowerCase();
        if (fname.endsWith(".xlsx") || fname.endsWith(".xls")) await stageExcelFile(file, log);
        else if (fname.endsWith(".csv")) await stageCSVFile(file, log);
        else if (fname.endsWith(".pdf")) await handlePDFFile(file, log);
        else appendLog(log, "Skipped (unsupported): " + file.name, "warn");
      }

      const fi = document.getElementById("importFileInput");
      if (fi) fi.value = "";

      if (stagedItems.length) {
        buildPreview();
      } else {
        appendLog(log, "No valid items found in selected file(s).", "warn");
      }
    }

    async function stageExcelFile(file, log) {
      appendLog(log, "üìä Reading: " + file.name, "warn");
      try {
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array', cellDates: true, cellNF: false, cellText: false });
        let sheetCount = 0;

        for (const sheetName of wb.SheetNames) {
          const ws = wb.Sheets[sheetName];
          if (!ws['!ref']) continue;
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: "" });
          if (!rows || rows.length < 2) continue;

          const detected = detectHeaderRow(rows);
          if (!detected) {
            appendLog(log, "  Sheet \"" + sheetName + "\": no recognisable header ‚Äî skipped", "warn");
            continue;
          }

          const { dataStartRow, colMap } = detected;
          const mapped = Object.entries(colMap).map(([f, i]) => f + "=col" + i).join(', ');
          appendLog(log, "  Sheet \"" + sheetName + "\": mapped " + mapped, "warn");

          let sheetAdded = 0;
          for (let r = dataStartRow; r < rows.length; r++) {
            const item = parseDataRow(rows[r], colMap);
            if (item) { stagedItems.push(item); sheetAdded++; }
          }

          if (sheetAdded) {
            appendLog(log, "  Sheet \"" + sheetName + "\": " + sheetAdded + " rows staged", "ok");
            sheetCount++;
          } else {
            appendLog(log, "  Sheet \"" + sheetName + "\": 0 valid rows found", "warn");
          }
        }

        if (!sheetCount) appendLog(log, "‚úó " + file.name + ": no usable sheets", "warn");
        else appendLog(log, "‚úì " + file.name + " parsed ‚Äî " + stagedItems.length + " items staged for review", "ok");
      } catch (err) {
        console.error("Excel stage error:", err);
        appendLog(log, "‚úó " + file.name + ": " + err.message, "warn");
      }
    }

    async function stageCSVFile(file, log) {
      appendLog(log, "üìã Reading: " + file.name, "warn");
      try {
        const text = await file.text();
        const rows = parseCSVToRows(text);
        if (rows.length < 2) { appendLog(log, "No data in: " + file.name, "warn"); return; }

        const detected = detectHeaderRow(rows);
        if (!detected) {
          appendLog(log, "‚úó " + file.name + ": no recognisable header row", "warn");
          return;
        }

        const { dataStartRow, colMap } = detected;
        const mapped = Object.entries(colMap).map(([f, i]) => f + "=col" + i).join(', ');
        appendLog(log, "  Mapped: " + mapped, "warn");

        let added = 0;
        for (let r = dataStartRow; r < rows.length; r++) {
          const item = parseDataRow(rows[r], colMap);
          if (item) { stagedItems.push(item); added++; }
        }

        if (!added) appendLog(log, "‚úó No valid rows in: " + file.name, "warn");
        else appendLog(log, "‚úì " + file.name + " parsed ‚Äî " + added + " rows staged for review", "ok");
      } catch (err) {
        appendLog(log, "‚úó " + file.name + ": " + err.message, "warn");
      }
    }

    function buildPreview() {
      let newCount = 0, updateCount = 0;

      const rows = stagedItems.map(item => {
        const isNew = !inventory[item.barcode];
        if (isNew) newCount++; else updateCount++;
        const badge = isNew
          ? '<span class="badge-new">NEW</span>'
          : '<span class="badge-update">UPDATE</span>';
        const rowClass = isNew ? 'row-new' : 'row-update';
        return '<tr class="' + rowClass + '">'
          + '<td>' + badge + '</td>'
          + '<td style="font-family:monospace;font-size:11px;opacity:.75;">' + escH(item.barcode) + '</td>'
          + '<td><strong>' + escH(item.product) + '</strong></td>'
          + '<td style="opacity:.7;">' + escH(item.model || '--') + '</td>'
          + '<td><span class="badge badge-cyan">' + escH(item.category || 'IT Equipment') + '</span></td>'
          + '<td style="color:var(--green);font-weight:600;">' + item.qty + '</td>'
          + '<td style="opacity:.7;">' + escH(item.location || 'IT Office') + '</td>'
          + '</tr>';
      }).join('');

      document.getElementById('importPreviewTable').innerHTML = rows;
      document.getElementById('previewNewCount').textContent = newCount;
      document.getElementById('previewUpdateCount').textContent = updateCount;
      document.getElementById('previewTotalCount').textContent = stagedItems.length;
      document.getElementById('submitBarCount').textContent = stagedItems.length;

      document.getElementById('importPreview').classList.add('show');
      document.getElementById('importSubmitBar').classList.add('show');
    }

    function hidePreview() {
      document.getElementById('importPreview').classList.remove('show');
      document.getElementById('importSubmitBar').classList.remove('show');
      document.getElementById('importPreviewTable').innerHTML = '';
    }

    function escH(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function submitImport() {
      if (!stagedItems.length) {
        showToast("Nothing staged to submit.", "warn");
        return;
      }

      const count = stagedItems.length;
      let added = 0, updated = 0;

      for (const row of stagedItems) {
        if (!row.barcode) continue;
        if (inventory[row.barcode]) {
          Object.assign(inventory[row.barcode], {
            product: row.product || inventory[row.barcode].product,
            model: row.model !== undefined ? row.model : inventory[row.barcode].model,
            category: row.category || inventory[row.barcode].category,
            location: row.location || inventory[row.barcode].location,
            qty: row.qty
          });
          updated++;
        } else {
          inventory[row.barcode] = row;
          added++;
        }
      }

      const now = new Date();
      const timeStr = now.toLocaleString();
      const dd = String(now.getDate()).padStart(2, "0");
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yyyy = now.getFullYear();
      const dateStr = dd + "/" + mm + "/" + yyyy;

      const importTx = stagedItems
        .filter(row => row.barcode)
        .map(row => ({
          time: timeStr,
          barcode: row.barcode,
          product: row.product || "Unknown",
          serial: "",
          category: row.category || "IT Equipment",
          direction: "IN",
          qty: row.qty || 0
        }));

      transactions.unshift(...importTx);

      try {
        const existing = JSON.parse(localStorage.getItem("itinv_all_transactions") || "[]");
        const stamped = importTx.map(t => ({
          date: dateStr,
          time: t.time,
          barcode: t.barcode,
          product: t.product,
          serial: t.serial || "",
          category: t.category || "IT Equipment",
          direction: t.direction,
          qty: t.qty
        }));
        const merged = stamped.concat(existing);
        localStorage.setItem("itinv_all_transactions", JSON.stringify(merged));
        localStorage.setItem("itinv_tx_last_push", now.toLocaleString());
      } catch (e) { console.warn("Failed to push import transactions to history:", e); }

      persist();

      saveInventoryToFolder().catch(e => console.warn("Background save failed:", e));

      refreshAll();

      stagedItems = [];
      hidePreview();
      document.getElementById('importLog').innerHTML = '';

      const msg = "‚úì Submitted: " + added + " new, " + updated + " updated (" + count + " total)";
      showToast(msg, "success");
      setStatus(msg + " ‚Äî " + importTx.length + " IN transactions logged to history");
    }

    function discardImport() {
      stagedItems = [];
      hidePreview();
      document.getElementById('importLog').innerHTML = '';
      showToast("Import discarded.", "warn");
      setStatus("Import discarded ‚Äî inventory unchanged.");
    }

    const COL_SYNONYMS = {
      barcode: [
        'barcode', 'bar code', 'bar_code', 'upc', 'ean', 'gtin', 'isbn', 'asin',
        'sku', 'item code', 'item no', 'item number', 'item #', 'item id',
        'product code', 'product no', 'product number', 'product id', 'product #',
        'part no', 'part number', 'part #', 'part id',
        'asset tag', 'asset no', 'asset number', 'asset id', 'asset #',
        'serial', 'serial no', 'serial number', 'serial #',
        'code', 'identifier', 'id', 'ref', 'reference'
      ],
      product: [
        'product', 'product name', 'product title', 'item', 'item name', 'item description',
        'description', 'desc', 'name', 'title', 'article', 'goods', 'merchandise',
        'device', 'equipment', 'hardware'
      ],
      model: [
        'model', 'model no', 'model number', 'model #', 'model name',
        'brand', 'make', 'manufacturer', 'vendor', 'supplier', 'mfr', 'mfg',
        'part name', 'part description', 'version', 'variant', 'sku name'
      ],
      category: [
        'category', 'cat', 'type', 'item type', 'product type', 'equipment type',
        'class', 'classification', 'group', 'department', 'section', 'division',
        'family', 'subcategory', 'sub category', 'sub-category'
      ],
      qty: [
        'qty', 'quantity', 'quantity on hand', 'on hand', 'in stock', 'stock',
        'count', 'units', 'unit count', 'total units', 'available', 'available qty',
        'balance', 'current stock', 'stock level', 'stock qty', 'amount', 'num'
      ],
      location: [
        'location', 'site', 'office', 'room', 'building', 'floor', 'zone',
        'warehouse', 'storage', 'bin', 'shelf', 'rack', 'area', 'place',
        'position', 'department', 'branch', 'store', 'depot'
      ]
    };

    function matchHeader(cellText) {
      const h = String(cellText || "").toLowerCase().trim()
        .replace(/[_\-\/\\]+/g, ' ').replace(/\s+/g, ' ');
      for (const [field, synonyms] of Object.entries(COL_SYNONYMS)) {
        for (const syn of synonyms) {

          if (h === syn || h.includes(syn)) return field;
        }
      }
      return null;
    }

    function detectHeaderRow(rows) {

      const scanLimit = Math.min(rows.length, 15);
      for (let r = 0; r < scanLimit; r++) {
        const colMap = {};
        const cells = rows[r];
        for (let c = 0; c < cells.length; c++) {
          const field = matchHeader(cells[c]);
          if (field && !(field in colMap)) colMap[field] = c;
        }

        if ('barcode' in colMap && 'product' in colMap) {
          return { headerRow: r, dataStartRow: r + 1, colMap };
        }

        if ('barcode' in colMap && Object.keys(colMap).length >= 3) {
          return { headerRow: r, dataStartRow: r + 1, colMap };
        }
      }
      return null;
    }

    function normaliseBarcode(raw) {
      const s = String(raw || "").trim().replace(/[\s\-\.]/g, '');
      if (!s || s.length < 4) return null;

      if (/^[A-Za-z0-9\-_#\/]{4,40}$/.test(s)) return s;
      return null;
    }

    function parseDataRow(cells, colMap) {
      const get = (field) => {
        if (!(field in colMap)) return "";
        return String(cells[colMap[field]] || "").trim();
      };

      const barcode = normaliseBarcode(get('barcode'));
      if (!barcode) return null;

      const product = get('product') || get('model') || "Imported Item";
      if (!product || product.length < 1) return null;

      const rawQty = get('qty');
      const qty = rawQty ? (parseInt(rawQty.replace(/[^0-9\-]/g, '')) || 1) : 1;

      const excelCategory = get('category').trim();
      const finalCategory = excelCategory || classifyCategory(product, get('model'), "");

      return {
        barcode,
        product,
        model: get('model') || "",
        category: finalCategory,
        qty: Math.max(0, qty),
        location: get('location') || "IT Office"
      };
    }

    function parseCSVToRows(text) {
      const rows = [];
      let row = [], field = '', inQuote = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuote) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; }
            else inQuote = false;
          } else { field += c; }
        } else {
          if (c === '"') { inQuote = true; }
          else if (c === ',') { row.push(field.trim()); field = ''; }
          else if (c === '\n' || c === '\r') {
            row.push(field.trim()); field = '';
            if (row.some(Boolean)) rows.push(row);
            row = [];
            if (c === '\r' && text[i + 1] === '\n') i++;
          } else { field += c; }
        }
      }
      if (field || row.length) { row.push(field.trim()); if (row.some(Boolean)) rows.push(row); }
      return rows;
    }

    async function handlePDFFile(file, log) {
      appendLog(log, "üìÑ Reading PDF: " + file.name, "warn");
      try {
        const text = await extractTextFromPDF(file);
        if (!text || text.length < 20) { appendLog(log, "‚úó Could not extract text from PDF: " + file.name, "warn"); return; }

        const lines = text.split(/\n/)
          .map(l => l.replace(/\s+/g, ' ').trim())
          .filter(l => l.length > 1);

        const rows = lines.map(l => l.split(/\t|  {2,}/).map(c => c.trim()));
        const detected = detectHeaderRow(rows);

        if (detected) {
          const { dataStartRow, colMap } = detected;
          appendLog(log, "  PDF table detected (header on line " + (detected.headerRow + 1) + ")", "warn");
          let added = 0;
          for (let r = dataStartRow; r < rows.length; r++) {
            const item = parseDataRow(rows[r], colMap);
            if (item) { stagedItems.push(item); added++; }
          }
          if (added) {
            appendLog(log, "‚úì " + file.name + " (table) ‚Äî " + added + " rows staged", "ok");
            return;
          }
        }

        appendLog(log, "  No table header found ‚Äî trying barcode-line scan...", "warn");
        const bcRx = /^([A-Za-z0-9\-_#\/]{4,40})\s+(.+)$/;
        let added = 0;
        for (const line of lines) {
          const m = line.match(bcRx);
          if (!m) continue;
          const bc = normaliseBarcode(m[1]);
          if (!bc) continue;
          const parts = m[2].split(/\s{2,}|\t/);
          stagedItems.push({
            barcode: bc, product: parts[0] || "Imported Item", model: parts[1] || "",
            category: parts[2] || "IT Equipment", qty: parseInt(parts[3]) || 1, location: parts[4] || "IT Office"
          });
          added++;
        }

        if (!added) { appendLog(log, "‚úó No inventory data found in PDF: " + file.name, "warn"); return; }
        appendLog(log, "‚úì " + file.name + " (scan) ‚Äî " + added + " rows staged", "ok");
      } catch (err) {
        appendLog(log, "‚úó " + file.name + ": " + err.message, "warn");
      }
    }

    async function extractTextFromPDF(file) {
      return new Promise(res => {
        const r = new FileReader();
        r.onload = e => {
          try {
            const b = new Uint8Array(e.target.result);
            let s = "";
            for (let i = 0; i < b.length; i++) {
              const c = b[i];
              if (c >= 32 && c < 127) s += String.fromCharCode(c);
              else if (c === 9 || c === 10 || c === 13) s += c === 9 ? "\t" : "\n";
            }
            res(s);
          } catch (err) { res(""); }
        };
        r.readAsArrayBuffer(file);
      });
    }

    function appendLog(el, msg, type) { const d = document.createElement("div"); d.className = "log-" + type; d.textContent = msg; el.appendChild(d); el.scrollTop = el.scrollHeight; }

    let refreshTimer = null;
    let chartRefreshTimer = null;

    function refreshAll() {

      if (refreshTimer) return;

      refreshTimer = requestAnimationFrame(() => {
        refreshTables();
        refreshTimer = null;
      });

      if (chartRefreshTimer) clearTimeout(chartRefreshTimer);
      chartRefreshTimer = setTimeout(() => {
        requestAnimationFrame(() => {
          refreshChart();
        });
      }, 300);
    }

    function refreshTables() {
      const items = Object.values(inventory), units = items.reduce((a, i) => a + i.qty, 0);
      document.getElementById("invCount").textContent = items.length;
      document.getElementById("invUnits").textContent = units;
      document.getElementById("txCount").textContent = transactions.length;
      document.getElementById("archiveCount").textContent = archive.length;

      const inv = document.getElementById("inventoryTable");
      inv.innerHTML = !items.length ? '<tr class="empty-row"><td colspan="7">No inventory items yet.</td></tr>' : items.map(i => { const qc = i.qty <= 0 ? "qty zero" : i.qty <= 2 ? "qty low" : "qty"; return '<tr><td>' + i.barcode + '</td><td>' + i.product + '</td><td>' + (i.model || "--") + '</td><td><span class="badge badge-cyan">' + (i.category || "--") + '</span></td><td class="' + qc + '">' + i.qty + '</td><td>' + i.location + '</td><td style="text-align:center;"><button onclick="deleteSingleItem(\'' + i.barcode + '\')" style="background:transparent;border:1px solid var(--red);color:var(--red);font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:3px;cursor:pointer;letter-spacing:1px;" title="Delete item">üóë DEL</button></td></tr>'; }).join("");

      const arch = document.getElementById("archiveTable");
      arch.innerHTML = !archive.length ? '<tr class="empty-row"><td colspan="7">No archived items yet.</td></tr>' : archive.slice(0, 100).map(a => { const statusBadge = a.status === "E-Waste" ? '<span style="display:inline-block;padding:2px 7px;border-radius:3px;font-size:10px;font-weight:700;background:rgba(168,85,247,0.15);color:#a855f7;border:1px solid rgba(168,85,247,0.35);">‚ôª E-WASTE</span>' : '<span class="archive-badge">' + (a.status || "Checked Out") + '</span>'; return '<tr><td>' + a.time + '</td><td>' + a.barcode + '</td><td>' + a.product + '</td><td><span class="archive-badge">' + (a.category || "--") + '</span></td><td class="qty">' + a.qty + '</td><td>' + statusBadge + '</td><td>' + a.location + '</td></tr>'; }).join("");

      const tx = document.getElementById("transactionTable");
      tx.innerHTML = !transactions.length ? '<tr class="empty-row"><td colspan="6">No transactions yet.</td></tr>' : transactions.slice(0, 200).map(t => '<tr><td>' + t.time + '</td><td>' + t.barcode + '</td><td>' + (t.product || "--") + '</td><td>' + (t.serial || "--") + '</td><td class="' + (t.direction === "IN" ? "dir-in" : t.direction === "E-WASTE" ? "dir-ewaste" : "dir-out") + '">' + t.direction + '</td><td>' + t.qty + '</td></tr>').join("");
    }
    const CHART_COLORS = ["#00e5ff", "#00ff88", "#ffaa00", "#ff3355", "#a855f7", "#f97316", "#06b6d4", "#84cc16", "#ec4899", "#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#14b8a6", "#d946ef", "#0ea5e9", "#22c55e", "#eab308", "#6366f1"];
    let _mainChartType = "bar", _mainChartFilter = "all";
    function setMainChartType(t) { _mainChartType = t; document.querySelectorAll(".chart-type-btn").forEach(b => b.classList.toggle("active", b.dataset.type === t)); refreshChart(); }
    function setMainChartFilter(f) { _mainChartFilter = f; document.querySelectorAll(".chart-filter-btn").forEach(b => b.classList.toggle("active", b.dataset.f === f)); refreshChart(); }
    function refreshChart() {
      const ctx = document.getElementById("stockChart").getContext("2d");
      if (stockChartInst) stockChartInst.destroy();
      const isPolar = _mainChartType === "pie" || _mainChartType === "doughnut" || _mainChartType === "polarArea";

      let labels, values, colors, chartLabel, borderColors;

      if (_mainChartFilter === "ewaste") {

        const ewtx = transactions.filter(t => t.direction === "E-WASTE");
        const ewarch = archive.filter(a => a.status === "E-Waste");
        const catMap = {};
        ewtx.forEach(t => { const k = t.category || "IT Equipment"; catMap[k] = (catMap[k] || 0) + t.qty; });
        ewarch.forEach(a => { const k = a.category || "IT Equipment"; catMap[k] = (catMap[k] || 0) + (a.qty || 1); });
        let entries = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
        if (!entries.length) { labels = ["No E-Waste yet"]; values = [0]; }
        else { labels = entries.map(e => e[0]); values = entries.map(e => e[1]); }
        colors = labels.map((_, i) => ["#a855f7", "#d946ef", "#8b5cf6", "#c084fc", "#7c3aed", "#e879f9", "#9333ea", "#a78bfa"][i % 8]);
        chartLabel = "E-Waste Disposed";
        borderColors = colors.map(c => c + "cc");
      } else {
        let items = Object.values(inventory);
        if (_mainChartFilter === "instock") items = items.filter(i => i.qty > 0);
        else if (_mainChartFilter === "low") items = items.filter(i => i.qty > 0 && i.qty <= 2);
        else if (_mainChartFilter === "zero") items = items.filter(i => i.qty <= 0);
        const catMap = {}; items.forEach(i => { const k = i.category || "IT Equipment"; catMap[k] = (catMap[k] || 0) + i.qty; });
        let entries = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
        if (_mainChartFilter === "topcat") entries = entries.slice(0, 8);
        labels = entries.map(e => e[0]); values = entries.map(e => e[1]);
        colors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);
        chartLabel = "Units in Stock";
        borderColors = colors.map(c => c + "cc");
      }

      const ds = { label: chartLabel, data: values, backgroundColor: colors.map(c => c + (isPolar ? "bb" : "44")), borderColor: borderColors, borderWidth: 2, borderRadius: isPolar ? 0 : 4, borderSkipped: false, hoverOffset: isPolar ? 8 : 0 };
      const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: isPolar, position: "right", labels: { color: "#cdd9e5", font: { family: "'Share Tech Mono',monospace", size: 9 }, boxWidth: 12, padding: 8 } }, tooltip: { backgroundColor: "#0e1620", borderColor: "#00e5ff44", borderWidth: 1, titleColor: "#00e5ff", bodyColor: "#cdd9e5", titleFont: { family: "'Share Tech Mono',monospace", size: 11 }, bodyFont: { family: "'Share Tech Mono',monospace", size: 12 }, callbacks: { title: i => Array.isArray(i) ? i[0].label : i.label, label: i => " Qty: " + i.raw } } } };
      if (!isPolar) opts.scales = { x: { ticks: { color: "#64748b", font: { family: "'Share Tech Mono',monospace", size: 9 }, maxRotation: 45, minRotation: 30 }, grid: { color: "rgba(26,48,64,0.6)" }, border: { color: "#1a3040" } }, y: { beginAtZero: true, ticks: { color: "#64748b", font: { family: "'Share Tech Mono',monospace", size: 9 }, stepSize: 1 }, grid: { color: "rgba(26,48,64,0.6)" }, border: { color: "#1a3040" } } };
      stockChartInst = new Chart(ctx, { type: _mainChartType, data: { labels, datasets: [ds] }, options: opts });
    }
    function showStockModal(product, available, requested) { document.getElementById("stockModalMsg").innerHTML = '<span>' + product + '</span><br><br>Requested: <span>' + requested + '</span> unit' + (requested > 1 ? "s" : "") + '<br>Available: <span style="color:var(--red)">' + available + '</span> unit' + (available !== 1 ? "s" : ""); document.getElementById("stockModal").classList.add("show"); }
    function closeStockModal() { document.getElementById("stockModal").classList.remove("show"); }
    document.getElementById("stockModal").addEventListener("click", function (e) { if (e.target === this) closeStockModal(); });
    function setStatus(msg) { document.getElementById("statusMsg").textContent = msg; }
    function showLookup(v) { document.getElementById("lookupStatus").classList.toggle("show", v); }
    let toastTimer;
    function showToast(msg, type = "success") {
      const t = document.getElementById("toast");
      if (type === "delete-single") {
        t.innerHTML = '<span style="font-size:16px;">üóë</span><span>' + msg + '</span>';
        t.className = "toast show delete-single";
      } else {
        t.textContent = msg;
        t.className = "toast show" + (type !== "success" ? " " + type : "");
      }
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove("show"), 3400);
    }
    function showDeleteAllToast(itemCount, unitCount) {
      const t = document.getElementById("toast");
      t.innerHTML = '<span class="da-icon">‚ö†Ô∏è</span><span class="da-title">Inventory Cleared</span><span class="da-sub">' + itemCount + ' items ¬∑ ' + unitCount + ' units permanently deleted &amp; archived</span>';
      t.className = "toast show delete-all";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove("show"), 5000);
    }

    

    const CP_PW_KEY = 'itinv_user_passwords';

    function cpSavePasswords() {
      try {
        const out = {};
        Object.keys(USERS).forEach(u => { out[u] = USERS[u].password; });
        localStorage.setItem(CP_PW_KEY, JSON.stringify(out));
      } catch(e) {}
    }

    function openChangePwTab() {

      ['cpUser','cpCurrent','cpNew','cpConfirm'].forEach(id => {
        const el = document.getElementById(id);
        el.value = '';
        el.classList.remove('cp-invalid','cp-valid');
      });
      document.getElementById('cpError').classList.remove('cp-show');
      document.getElementById('cpStrengthFill').style.width = '0%';
      document.getElementById('cpStrengthFill').style.background = '';
      document.getElementById('cpStrengthText').textContent = '‚Äî';
      document.getElementById('cpStrengthText').style.color = '';
      document.getElementById('cpForm').style.display = '';
      document.getElementById('cpSuccess').classList.remove('cp-show');
      document.getElementById('cpPopup').classList.add('open');
      setTimeout(() => document.getElementById('cpUser').focus(), 80);
    }

    function closeCpPopup() {
      document.getElementById('cpPopup').classList.remove('open');
    }

    function cpClearErr() {
      document.getElementById('cpError').classList.remove('cp-show');
    }

    function cpOnNewInput() {
      cpClearErr();
      const v = document.getElementById('cpNew').value;
      let score = 0;
      if (v.length >= 6)          score++;
      if (v.length >= 10)         score++;
      if (/[A-Z]/.test(v))        score++;
      if (/[0-9]/.test(v))        score++;
      if (/[^A-Za-z0-9]/.test(v)) score++;
      const pcts  = [0, 20, 40, 65, 85, 100];
      const clrs  = ['#1a3040','#ff3355','#ff7733','#ffaa00','#aadd00','#00ff88'];
      const lbls  = ['‚Äî','Weak','Fair','Good','Strong','Excellent'];
      const fill  = document.getElementById('cpStrengthFill');
      const lbl   = document.getElementById('cpStrengthText');
      fill.style.width      = pcts[score] + '%';
      fill.style.background = clrs[score];
      lbl.textContent       = lbls[score];
      lbl.style.color       = clrs[score];
      cpOnConfirmInput();
    }

    function cpOnConfirmInput() {
      const nw  = document.getElementById('cpNew').value;
      const cfm = document.getElementById('cpConfirm');
      if (!cfm.value) { cfm.classList.remove('cp-valid','cp-invalid'); return; }
      if (nw === cfm.value) { cfm.classList.add('cp-valid');   cfm.classList.remove('cp-invalid'); }
      else                  { cfm.classList.add('cp-invalid'); cfm.classList.remove('cp-valid'); }
    }

    function cpShowErr(msg) {
      const el = document.getElementById('cpError');
      el.textContent = msg;
      el.classList.add('cp-show');
    }

    function cpSubmit() {
      const username = document.getElementById('cpUser').value.trim().toLowerCase();
      const cur      = document.getElementById('cpCurrent').value;
      const nw       = document.getElementById('cpNew').value;
      const cfm      = document.getElementById('cpConfirm').value;

      cpClearErr();

      if (!username) {
        cpShowErr('Username is required.');
        document.getElementById('cpUser').focus();
        return;
      }
      if (!USERS[username]) {
        cpShowErr('Invalid username or password.');
        document.getElementById('cpUser').classList.add('cp-invalid');
        setTimeout(() => document.getElementById('cpUser').classList.remove('cp-invalid'), 600);
        return;
      }
      if (!cur) {
        cpShowErr('Current password is required.');
        document.getElementById('cpCurrent').focus();
        return;
      }
      if (USERS[username].password !== cur) {
        cpShowErr('Invalid username or password.');
        document.getElementById('cpCurrent').value = '';
        document.getElementById('cpCurrent').classList.add('cp-invalid');
        setTimeout(() => document.getElementById('cpCurrent').classList.remove('cp-invalid'), 600);
        document.getElementById('cpCurrent').focus();
        return;
      }
      if (nw.length < 6) {
        cpShowErr('New password must be at least 6 characters.');
        document.getElementById('cpNew').focus();
        return;
      }
      if (nw === cur) {
        cpShowErr('New password must differ from your current password.');
        document.getElementById('cpNew').focus();
        return;
      }
      if (nw !== cfm) {
        cpShowErr('Passwords do not match.');
        document.getElementById('cpConfirm').classList.add('cp-invalid');
        document.getElementById('cpConfirm').focus();
        return;
      }


      USERS[username].password = nw;
      cpSavePasswords();


      document.getElementById('cpForm').style.display = 'none';
      document.getElementById('cpSuccess').classList.add('cp-show');
    }


    document.getElementById('cpPopup').addEventListener('click', function(e) {
      if (e.target === this) closeCpPopup();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('cpPopup').classList.contains('open')) {
        closeCpPopup();
      }
    });

    window.addEventListener('message', function (e) {
      if (!e.data) return;
      if (e.data.type === 'itinv_request_update') {
        try {
          if (e.source && !e.source.closed) {
            window._liveViewWindows = (window._liveViewWindows || []).filter(w => w && !w.closed);
            if (!window._liveViewWindows.includes(e.source)) window._liveViewWindows.push(e.source);
            e.source.postMessage({ type: 'itinv_update', inventory: inventory, lowThreshold: 2 }, '*');
          }
        } catch (err) { }
      }
      if (e.data.type === 'itinv_ack') { }
      if (e.data.type === 'itinv_edit' && e.data.item) {
        const item = e.data.item;
        if (item.barcode) {
          inventory[item.barcode] = item;
          persist();
          saveInventoryToFolder().catch(() => { });
          refreshAll();
          showToast('\u2713 Live edit saved: ' + item.product);
        }
      }
    });

    let _liveViewBlobUrl = null;
    window._liveViewWindows = [];

    function openAssignPage() {
      if (!currentUser) { showToast('Please log in first.', 'warn'); return; }

      const here = window.location.href;
      const base = here.substring(0, here.lastIndexOf('/') + 1);
      const url = base + 'it-assign.html';
      const w = window.open(url, '_blank');
      if (!w) {
        showToast('Popup blocked ‚Äî please allow popups for this page.', 'warn');
      }
    }

    function openLiveView() {
      const width = 1200;
      const height = 800;
      const left = Math.max(0, (screen.width - width) / 2);
      const top = Math.max(0, (screen.height - height) / 2);

      const snapshot = JSON.stringify(inventory);
      const ts = new Date().toLocaleString();
      const html = generateLiveViewHTML(snapshot, ts);

      const liveWindow = window.open(
        '', 'InventoryLiveView',
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );

      if (liveWindow) {
        liveWindow.document.open();
        liveWindow.document.write(html);
        liveWindow.document.close();

        window._liveViewWindows = window._liveViewWindows.filter(w => w && !w.closed);
        window._liveViewWindows.push(liveWindow);
        showToast("Live View opened");

        let _ackReceived = false;
        function _onAck(ev) { if (ev.data && ev.data.type === 'itinv_ack') { _ackReceived = true; window.removeEventListener('message', _onAck); } }
        window.addEventListener('message', _onAck);
        const _pi = setInterval(() => {
          if (_ackReceived || liveWindow.closed) { clearInterval(_pi); return; }
          try { liveWindow.postMessage({ type: 'itinv_update', inventory: inventory, lowThreshold: 2 }, '*'); } catch (e) { }
        }, 200);
        setTimeout(() => { clearInterval(_pi); window.removeEventListener('message', _onAck); }, 8000);
      } else {
        showToast("Allow popups for this page to open Live View", "warn");
      }
    }

    function generateLiveViewHTML(inventorySnapshot, timestamp) {
      const safeSnapshot = '';
      const safeTimestamp = (timestamp || new Date().toLocaleString()).replace(/`/g, '\\`');

      const safeSnapshotAttr = (inventorySnapshot || '{}').replace(/&/g, '&amp;').replace(/'/g, '&apos;');

      return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>it-inventory ‚Äî live</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.6/JsBarcode.all.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0d1b2a 0%, #1b2838 50%, #0d1b2a 100%);
    color: #fff;
    min-height: 100vh;
    padding: 20px;
  }
  .header {
    background: rgba(0,229,255,0.07);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 12px;
    padding: 20px 30px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }
  .header h1 { font-size: 26px; font-weight: 700; letter-spacing: 1px; }
  .header-right { display: flex; gap: 30px; flex-wrap: wrap; }
  .stat { text-align: center; min-width: 70px; }
  .stat-value { font-size: 30px; font-weight: 700; }
  .stat-value.green  { color: #00ff88; }
  .stat-value.amber  { color: #ffaa00; }
  .stat-value.cyan   { color: #00e5ff; }
  .stat-label { font-size: 11px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
  .controls {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 14px 18px;
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  .search-box { flex: 1; min-width: 200px; position: relative; }
  .search-box input {
    width: 100%;
    padding: 10px 14px 10px 38px;
    border: 1px solid rgba(0,229,255,0.3);
    border-radius: 8px;
    background: rgba(0,0,0,0.3);
    color: #fff;
    font-size: 14px;
    outline: none;
    transition: border-color .2s;
  }
  .search-box input:focus { border-color: #00e5ff; }
  .search-box input::placeholder { color: rgba(255,255,255,0.35); }
  .search-icon {
    position: absolute; left: 11px; top: 50%;
    transform: translateY(-50%); font-size: 15px; pointer-events: none;
  }
  .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
  .filter-btn {
    padding: 9px 18px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    background: rgba(255,255,255,0.07);
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
  }
  .filter-btn:hover { background: rgba(255,255,255,0.14); color: #fff; }
  .filter-btn.active-all     { background: #00e5ff22; border-color: #00e5ff; color: #00e5ff; font-weight: 700; }
  .filter-btn.active-instock { background: #00ff8822; border-color: #00ff88; color: #00ff88; font-weight: 700; }
  .filter-btn.active-low     { background: #ffaa0022; border-color: #ffaa00; color: #ffaa00; font-weight: 700; }
  .refresh-btn {
    padding: 9px 18px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #00e5ff, #0099cc);
    color: #000;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    white-space: nowrap;
  }
  .refresh-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,229,255,0.4); }
  .edit-btn {
    padding: 5px 12px;
    border: 1px solid rgba(0,229,255,0.4);
    border-radius: 6px;
    background: rgba(0,229,255,0.1);
    color: #00e5ff;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .edit-btn:hover {
    background: rgba(0,229,255,0.2);
    border-color: #00e5ff;
    transform: translateY(-1px);
  }
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.show { display: flex; }
  .modal-box {
    background: linear-gradient(135deg, #1b2838 0%, #0d1b2a 100%);
    border: 1px solid rgba(0,229,255,0.3);
    border-radius: 12px;
    padding: 24px 28px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: modalSlideIn 0.3s ease;
  }
  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .modal-header {
    font-size: 20px;
    font-weight: 700;
    color: #00e5ff;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .modal-field {
    margin-bottom: 14px;
  }
  .modal-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .modal-field input,
  .modal-field select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid rgba(0,229,255,0.3);
    border-radius: 6px;
    background: rgba(0,0,0,0.3);
    color: #fff;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .modal-field input:focus,
  .modal-field select:focus {
    border-color: #00e5ff;
  }
  .modal-field input[readonly] {
    background: rgba(0,0,0,0.2);
    opacity: 0.6;
    cursor: not-allowed;
  }
  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end;
  }
  .modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .modal-btn-cancel {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.2);
  }
  .modal-btn-cancel:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
  }
  .modal-btn-save {
    background: linear-gradient(135deg, #00ff88, #00cc66);
    color: #000;
  }
  .modal-btn-save:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(0,255,136,0.4);
  }
  .table-container {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    overflow: hidden;
  }
  table { width: 100%; border-collapse: collapse; }
  thead { background: rgba(0,0,0,0.35); }
  th {
    padding: 13px 18px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #00e5ff;
    border-bottom: 1px solid rgba(0,229,255,0.2);
  }
  td { padding: 13px 18px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
  tbody tr:last-child td { border-bottom: none; }
  tbody tr:hover { background: rgba(0,229,255,0.04); }
  .badge-cat {
    display: inline-block; padding: 3px 10px; border-radius: 10px;
    font-size: 11px; font-weight: 600;
    background: rgba(0,180,220,0.2); border: 1px solid rgba(0,180,220,0.4); color: #7edfff;
  }
  .qty-val { font-weight: 700; font-size: 16px; }
  .qty-val.high   { color: #00ff88; }
  .qty-val.medium { color: #00e5ff; }
  .qty-val.low    { color: #ffaa00; }
  .qty-val.zero   { color: #ff3355; }
  .row-low  { background: rgba(255,170,0,0.04) !important; }
  .row-zero { background: rgba(255,51,85,0.04) !important; }
  .empty-state { text-align: center; padding: 50px 20px; opacity: 0.5; }
  .empty-state div { font-size: 40px; margin-bottom: 10px; }
  .footer {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 14px; padding: 0 4px;
    font-size: 11px; opacity: 0.5; flex-wrap: wrap; gap: 8px;
  }
  
.sys-sig{font-family:var(--mono);font-size:8px;letter-spacing:1.5px;
  color:var(--text-dim);opacity:0.35;user-select:none;text-transform:uppercase;
  transition:opacity .3s;white-space:nowrap;margin-left:2px;}
.sys-sig:hover{opacity:0.7;}
[data-theme="light"] .sys-sig{opacity:0.28;}

  .live-dot {
    display: inline-block; width: 7px; height: 7px;
    border-radius: 50%; background: #00ff88; margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .low-badge {
    display: inline-block; margin-left: 8px; padding: 1px 6px;
    border-radius: 4px; font-size: 10px; font-weight: 700;
    background: rgba(255,170,0,0.25); border: 1px solid rgba(255,170,0,0.5);
    color: #ffaa00; vertical-align: middle; letter-spacing: 0.5px;
  }
  .bc-wrap { display:flex; align-items:center; }
  .bc-wrap canvas { display:block; height:88px; width:auto; max-width:200px; border-radius:4px; }
  .bc-num { font-family:monospace; font-size:11px; opacity:.6; letter-spacing:.5px; }
  .charts-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;
  }
  @media(max-width:900px){ .charts-row { grid-template-columns: 1fr; } }
  .chart-card {
    background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.15);
    border-radius: 12px; padding: 20px 24px;
  }
  .chart-card h2 {
    font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
    color: #00e5ff; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .chart-card h2::before {
    content: ''; display: inline-block; width: 3px; height: 14px;
    background: #00e5ff; border-radius: 2px;
  }
  .chart-wrap { position: relative; height: 220px; }
  .lv-type-btn,.lv-filter-btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);
    color:rgba(255,255,255,0.5);font-family:'Share Tech Mono',monospace;font-size:10px;
    padding:3px 8px;border-radius:4px;cursor:pointer;transition:all .15s;white-space:nowrap;letter-spacing:0.3px;}
  .lv-type-btn:hover{border-color:#00e5ff;color:#00e5ff;}
  .lv-type-btn.active{background:rgba(0,229,255,0.12);border-color:#00e5ff;color:#00e5ff;font-weight:700;}
  .lv-filter-btn:hover{border-color:#ffaa00;color:#ffaa00;}
  .lv-filter-btn.active{background:rgba(255,170,0,0.12);border-color:#ffaa00;color:#ffaa00;font-weight:700;}
  .picker-wrap{position:relative;}
  .picker-toggle{background:rgba(168,85,247,0.08);border:1px solid rgba(168,85,247,0.35);color:rgba(168,85,247,0.85);
    font-family:'Share Tech Mono',monospace;font-size:10px;padding:3px 9px;border-radius:4px;cursor:pointer;
    transition:all .15s;white-space:nowrap;letter-spacing:0.3px;user-select:none;}
  .picker-toggle:hover{border-color:#a855f7;color:#a855f7;}
  .picker-toggle.has-sel{background:rgba(168,85,247,0.2);border-color:#a855f7;color:#a855f7;font-weight:700;}
  .picker-panel{display:none;position:absolute;top:calc(100% + 6px);left:0;z-index:999;
    background:#0d1b2a;border:1px solid rgba(168,85,247,0.4);border-radius:8px;
    box-shadow:0 8px 32px rgba(0,0,0,0.6);width:240px;overflow:hidden;}
  .picker-panel.open{display:flex;flex-direction:column;}
  .picker-search{background:#091420;border:none;border-bottom:1px solid rgba(168,85,247,0.2);
    color:#e2d9f3;font-family:'Share Tech Mono',monospace;font-size:11px;padding:8px 12px;outline:none;width:100%;}
  .picker-search::placeholder{color:rgba(168,85,247,0.4);}
  .picker-actions{display:flex;border-bottom:1px solid rgba(168,85,247,0.15);}
  .picker-action-btn{flex:1;background:transparent;border:none;color:rgba(168,85,247,0.6);
    font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:0.5px;text-transform:uppercase;
    padding:5px 0;cursor:pointer;transition:all .12s;}
  .picker-action-btn:hover{background:rgba(168,85,247,0.1);color:#a855f7;}
  .picker-action-btn:not(:last-child){border-right:1px solid rgba(168,85,247,0.15);}
  .picker-list{max-height:200px;overflow-y:auto;padding:4px 0;}
  .picker-list::-webkit-scrollbar{width:4px;}
  .picker-list::-webkit-scrollbar-thumb{background:rgba(168,85,247,0.4);border-radius:2px;}
  .picker-item{display:flex;align-items:center;gap:8px;padding:5px 12px;cursor:pointer;transition:background .1s;
    font-family:'Share Tech Mono',monospace;font-size:11px;color:#cdd9e5;}
  .picker-item:hover{background:rgba(168,85,247,0.1);}
  .picker-item input[type=checkbox]{accent-color:#a855f7;width:13px;height:13px;cursor:pointer;flex-shrink:0;}
  .picker-item label{cursor:pointer;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .picker-footer{border-top:1px solid rgba(168,85,247,0.2);padding:6px 10px;display:flex;
    justify-content:space-between;align-items:center;font-family:'Share Tech Mono',monospace;
    font-size:9px;color:rgba(168,85,247,0.5);}
  .picker-apply{background:rgba(168,85,247,0.2);border:1px solid rgba(168,85,247,0.5);color:#a855f7;
    font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:0.5px;text-transform:uppercase;
    padding:3px 10px;border-radius:3px;cursor:pointer;transition:all .12s;}
  .picker-apply:hover{background:rgba(168,85,247,0.35);}

  
  .pw-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:5000;
    display:none;align-items:center;justify-content:center;padding:20px;}
  .pw-modal-overlay.show{display:flex;}
  .pw-modal-box{background:var(--card);border:1px solid rgba(0,229,255,0.35);border-radius:10px;
    padding:32px;width:100%;max-width:400px;box-shadow:0 24px 64px rgba(0,0,0,.6),0 0 40px rgba(0,229,255,0.06);}
  [data-theme="light"] .pw-modal-box{border-color:rgba(0,119,170,0.3);box-shadow:0 24px 64px rgba(0,0,0,.2);}
  .pw-modal-box h3{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
    color:var(--text-bright);margin-bottom:6px;display:flex;align-items:center;gap:8px;}
  .pw-modal-box h3::before{content:'';display:inline-block;width:3px;height:16px;background:var(--cyan);border-radius:2px;}
  .pw-modal-sub{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:.5px;margin-bottom:22px;}
  .pw-field{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
  .pw-field label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
    color:var(--cyan-dim);font-family:var(--mono);}
  .pw-field input{background:var(--input-bg);border:1px solid var(--border);border-radius:4px;
    color:var(--text-bright);padding:10px 14px;font-family:var(--mono);font-size:13px;
    outline:none;transition:all .2s;width:100%;}
  .pw-field input:focus{border-color:var(--cyan);box-shadow:0 0 10px rgba(0,229,255,0.15);}
  .pw-error{font-family:var(--mono);font-size:11px;color:var(--red);min-height:16px;margin-bottom:10px;
    background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.25);border-radius:3px;
    padding:6px 10px;display:none;}
  .pw-error.show{display:block;}
  .pw-modal-actions{display:flex;gap:8px;margin-top:6px;}
  .pw-strength{height:3px;border-radius:3px;background:var(--border);margin-top:4px;overflow:hidden;}
  .pw-strength-bar{height:100%;border-radius:3px;transition:width .3s,background .3s;width:0%;}

</style>
</head>
<body data-inv='${safeSnapshotAttr}'>
<div class="header">
  <div>
    <h1><span class="live-dot"></span>it-inventory ‚Äî live view</h1>
  </div>
  <div class="header-right">
    <div class="stat"><div class="stat-value cyan" id="statTotal">0</div><div class="stat-label">Total SKUs</div></div>
    <div class="stat"><div class="stat-value green" id="statUnits">0</div><div class="stat-label">Total Units</div></div>
    <div class="stat"><div class="stat-value green" id="statInStock">0</div><div class="stat-label">In Stock</div></div>
    <div class="stat"><div class="stat-value amber" id="statLow">0</div><div class="stat-label">Low Stock</div></div>
    <div class="stat" style="border-left:1px solid rgba(255,255,255,0.1);padding-left:14px;">
      <div style="display:flex;align-items:center;gap:6px;">
        <span id="connDot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ffaa00;box-shadow:0 0 6px #ffaa00;transition:all .4s;flex-shrink:0;"></span>
        <span id="connLabel" style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ffaa00;transition:color .4s;">Connecting‚Ä¶</span>
      </div>
      <div class="stat-label">Main App</div>
    </div>
  </div>
</div>

<div class="controls">
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search barcode, product, model, category, location...">
  </div>
  <div class="btn-group">
    <button class="filter-btn" id="btn-all"     onclick="setFilter('all')">All Items</button>
    <button class="filter-btn" id="btn-instock"  onclick="setFilter('instock')">In Stock</button>
    <button class="filter-btn" id="btn-low"      onclick="setFilter('low')">‚ö† Low Stock</button>
    <button class="refresh-btn" onclick="pullFromOpener()">üîÑ Refresh</button>
    <select id="refreshIntervalSelect" style="background:#0a1118;border:1px solid rgba(0,229,255,0.2);border-radius:6px;color:#00e5ff;font-family:'Share Tech Mono',monospace;font-size:11px;padding:6px 10px;cursor:pointer;outline:none;">
      <option value="10000">Auto: 10s</option>
      <option value="30000" selected>Auto: 30s</option>
      <option value="60000">Auto: 1 min</option>
      <option value="300000">Auto: 5 min</option>
      <option value="600000">Auto: 10 min</option>
      <option value="0">Auto: Off</option>
    </select>
  </div>
</div>

<div class="charts-row">
  <div class="chart-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
      <h2 style="margin-bottom:0;">Units by Category</h2>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button class="lv-type-btn active" onclick="setLiveChartType('cat','bar')" data-chart="cat" data-type="bar">‚ñê‚ñã Bar</button>
        <button class="lv-type-btn" onclick="setLiveChartType('cat','line')" data-chart="cat" data-type="line">üìà Line</button>
        <button class="lv-type-btn" onclick="setLiveChartType('cat','pie')" data-chart="cat" data-type="pie">ü•ß Pie</button>
        <button class="lv-type-btn" onclick="setLiveChartType('cat','doughnut')" data-chart="cat" data-type="doughnut">‚≠ï Ring</button>
        <button class="lv-type-btn" onclick="setLiveChartType('cat','polarArea')" data-chart="cat" data-type="polarArea">üéØ Polar</button>
      </div>
    </div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;align-items:center;">
      <span style="font-family:monospace;font-size:9px;color:rgba(0,229,255,0.6);letter-spacing:1px;text-transform:uppercase;margin-right:2px;">Filter:</span>
      <button class="lv-filter-btn active" onclick="setLiveChartFilter('cat','all')" data-chart="cat" data-f="all">All</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('cat','instock')" data-chart="cat" data-f="instock">In Stock</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('cat','low')" data-chart="cat" data-f="low">‚ö† Low</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('cat','zero')" data-chart="cat" data-f="zero">Zero</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('cat','top8')" data-chart="cat" data-f="top8">Top 8</button>
      <div class="picker-wrap">
        <button class="picker-toggle" id="catCatToggle" onclick="togglePicker('catCat')">üè∑ Categories ‚ñæ</button>
        <div class="picker-panel" id="catCatPanel">
          <input class="picker-search" id="catCatSearch" placeholder="Search‚Ä¶" oninput="filterPickerList('catCat')">
          <div class="picker-actions">
            <button class="picker-action-btn" onclick="pickerSelectAll('catCat')">All</button>
            <button class="picker-action-btn" onclick="pickerClearAll('catCat')">None</button>
            <button class="picker-action-btn" onclick="pickerInvert('catCat')">Invert</button>
          </div>
          <div class="picker-list" id="catCatList"></div>
          <div class="picker-footer"><span id="catCatCount">0 selected</span><button class="picker-apply" onclick="applyPicker('cat','catCat')">Apply ‚úì</button></div>
        </div>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="liveChartCat"></canvas></div>
  </div>
  <div class="chart-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
      <h2 style="margin-bottom:0;">Items by Category</h2>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        <button class="lv-type-btn active" onclick="setLiveChartType('items','bar')" data-chart="items" data-type="bar">‚ñê‚ñã Bar</button>
        <button class="lv-type-btn" onclick="setLiveChartType('items','line')" data-chart="items" data-type="line">üìà Line</button>
        <button class="lv-type-btn" onclick="setLiveChartType('items','pie')" data-chart="items" data-type="pie">ü•ß Pie</button>
        <button class="lv-type-btn" onclick="setLiveChartType('items','doughnut')" data-chart="items" data-type="doughnut">‚≠ï Ring</button>
        <button class="lv-type-btn" onclick="setLiveChartType('items','polarArea')" data-chart="items" data-type="polarArea">üéØ Polar</button>
      </div>
    </div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;align-items:center;">
      <span style="font-family:monospace;font-size:9px;color:rgba(0,229,255,0.6);letter-spacing:1px;text-transform:uppercase;margin-right:2px;">Filter:</span>
      <button class="lv-filter-btn active" onclick="setLiveChartFilter('items','all')" data-chart="items" data-f="all">All</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('items','instock')" data-chart="items" data-f="instock">In Stock</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('items','low')" data-chart="items" data-f="low">‚ö† Low</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('items','zero')" data-chart="items" data-f="zero">Zero</button>
      <button class="lv-filter-btn" onclick="setLiveChartFilter('items','top8')" data-chart="items" data-f="top8">Top 8</button>
      <div class="picker-wrap">
        <button class="picker-toggle" id="itemsCatToggle" onclick="togglePicker('itemsCat')">üè∑ Categories ‚ñæ</button>
        <div class="picker-panel" id="itemsCatPanel">
          <input class="picker-search" id="itemsCatSearch" placeholder="Search‚Ä¶" oninput="filterPickerList('itemsCat')">
          <div class="picker-actions">
            <button class="picker-action-btn" onclick="pickerSelectAll('itemsCat')">All</button>
            <button class="picker-action-btn" onclick="pickerClearAll('itemsCat')">None</button>
            <button class="picker-action-btn" onclick="pickerInvert('itemsCat')">Invert</button>
          </div>
          <div class="picker-list" id="itemsCatList"></div>
          <div class="picker-footer"><span id="itemsCatCount">0 selected</span><button class="picker-apply" onclick="applyPicker('items','itemsCat')">Apply ‚úì</button></div>
        </div>
      </div>
      <div class="picker-wrap">
        <button class="picker-toggle" id="itemsNameToggle" onclick="togglePicker('itemsName')">üì¶ Items ‚ñæ</button>
        <div class="picker-panel" id="itemsNamePanel">
          <input class="picker-search" id="itemsNameSearch" placeholder="Search‚Ä¶" oninput="filterPickerList('itemsName')">
          <div class="picker-actions">
            <button class="picker-action-btn" onclick="pickerSelectAll('itemsName')">All</button>
            <button class="picker-action-btn" onclick="pickerClearAll('itemsName')">None</button>
            <button class="picker-action-btn" onclick="pickerInvert('itemsName')">Invert</button>
          </div>
          <div class="picker-list" id="itemsNameList"></div>
          <div class="picker-footer"><span id="itemsNameCount">0 selected</span><button class="picker-apply" onclick="applyPicker('items','itemsName')">Apply ‚úì</button></div>
        </div>
      </div>
    </div>
    <div class="chart-wrap"><canvas id="liveChartItems"></canvas></div>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Product</th>
        <th>Model / Brand</th>
        <th>Category</th>
        <th>Qty</th>
        <th>Location</th>
        <th style="text-align:center;width:80px;">Actions</th>
      </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
  </table>
</div>

<div class="footer">
  <span id="footerLeft">Showing 0 items</span>
  <span id="lastUpdated">Last updated: ${safeTimestamp}</span>
</div>

<div class="modal-overlay" id="editModal">
  <div class="modal-box">
    <div class="modal-header">‚úèÔ∏è Edit Inventory Item</div>
    <div class="modal-field">
      <label>Barcode</label>
      <input type="text" id="editBarcode" readonly>
    </div>
    <div class="modal-field">
      <label>Product Name</label>
      <input type="text" id="editProduct">
    </div>
    <div class="modal-field">
      <label>Model / Brand</label>
      <input type="text" id="editModel">
    </div>
    <div class="modal-field">
      <label>Category</label>
      <select id="editCategory">
        <option value="">-- Select Category --</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Quantity</label>
      <input type="number" id="editQty" min="0">
    </div>
    <div class="modal-field">
      <label>Location</label>
      <input type="text" id="editLocation">
    </div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
      <button class="modal-btn modal-btn-save" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<script>

let allData = [];
let currentFilter = 'instock';
let LOW_THRESHOLD = 2;

let _toastTimer;
function liveToast(msg, type){
  let t = document.getElementById('liveToast');
  if(!t){
    t = document.createElement('div');
    t.id = 'liveToast';
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;'
      + 'font-size:13px;font-weight:600;z-index:9999;transition:opacity .3s;pointer-events:none;opacity:0;'
      + 'background:#1b2838;border:1px solid rgba(0,229,255,0.4);color:#fff;max-width:340px;';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.background = type === 'error' ? 'rgba(255,51,85,0.2)'
    : type === 'warn'  ? 'rgba(255,170,0,0.2)'
    : 'rgba(0,255,136,0.15)';
  t.style.borderColor = type === 'error' ? 'rgba(255,51,85,0.6)'
    : type === 'warn'  ? 'rgba(255,170,0,0.6)'
    : 'rgba(0,255,136,0.5)';
  t.style.opacity = '1';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 3000);
}

function pullFromOpener(){
  if(window.opener&&!window.opener.closed){
    try{ window.opener.postMessage({type:'itinv_request_update'},'*'); }catch(e){}
  }
}

window.addEventListener('message',function(e){
  if(e.data&&e.data.type==='itinv_update'&&e.data.inventory){
    if(typeof e.data.lowThreshold==='number') LOW_THRESHOLD=e.data.lowThreshold;
    allData=Object.values(e.data.inventory);
    document.getElementById('lastUpdated').textContent='Live \u2022 '+new Date().toLocaleTimeString()+' \u2014 '+allData.length+' items';
    const dot=document.getElementById('connDot'),lbl=document.getElementById('connLabel');
    if(dot){dot.style.background='#00ff88';dot.style.boxShadow='0 0 8px #00ff88';}
    if(lbl){lbl.textContent='Connected';lbl.style.color='#00ff88';}
    _gotFirstPush=true;

    try{ if(window.opener&&!window.opener.closed) window.opener.postMessage({type:'itinv_ack'},'*'); }catch(ex){}
    renderAll();
  }
});

function setFilter(type){
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn');
  document.getElementById('btn-' + type).className = 'filter-btn active-' + type;
  renderAll();
}

function renderAll(){
  const search = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = allData.filter(item => {
    const qty = Number(item.qty) || 0;
    if(currentFilter === 'instock' && qty <= 0) return false;
    if(currentFilter === 'low' && (qty > LOW_THRESHOLD || qty <= 0)) return false;
    if(search){
      const hay = [item.barcode, item.product, item.model, item.category, item.location]
        .join(' ').toLowerCase();
      if(!hay.includes(search)) return false;
    }
    return true;
  });
  renderTable(filtered);
  renderStats();
  document.getElementById('footerLeft').textContent =
    'Showing ' + filtered.length + ' of ' + allData.length + ' items';
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&#39;'); }

function renderTable(items){
  const tbody = document.getElementById('inventoryTable');
  if(!items.length){
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div>üì¶</div><p>No items match this filter.</p></td></tr>';
    return;
  }
  tbody.innerHTML = items.map(item => {
    const qty      = Number(item.qty) || 0;
    const qtyClass = qty <= 0 ? 'zero' : qty <= LOW_THRESHOLD ? 'low' : qty <= 10 ? 'medium' : 'high';
    const rowClass = qty <= 0 ? 'row-zero' : qty <= LOW_THRESHOLD ? 'row-low' : '';
    const lowBadge = (qty > 0 && qty <= LOW_THRESHOLD) ? '<span class="low-badge">LOW</span>' : '';
    const bcId = 'bc_' + esc(item.barcode).replace(/[^a-zA-Z0-9]/g,'_');
    return '<tr class="' + rowClass + '">'
      + '<td><div class="bc-wrap"><canvas id="' + bcId + '" data-bc="' + esc(item.barcode) + '"></canvas></div></td>'
      + '<td><strong>'                                                   + esc(item.product||'--')            + '</strong>' + lowBadge + '</td>'
      + '<td style="opacity:.75;">'                                      + esc(item.model||'--')              + '</td>'
      + '<td><span class="badge-cat">'                                   + esc(item.category||'IT Equipment') + '</span></td>'
      + '<td><span class="qty-val ' + qtyClass + '">'                   + qty                                + '</span></td>'
      + '<td style="opacity:.75;">'                                      + esc(item.location||'IT Office')    + '</td>'
      + '<td style="text-align:center;"><button class="edit-btn" data-bc="' + esc(item.barcode) + '">&#9998; Edit</button></td>'
      + '</tr>';
  }).join('');
  renderBarcodes();
}

function getBarcodeFormat(bc){
  const s = String(bc).trim();
  if(/^\d{13}$/.test(s)) return 'EAN13';
  if(/^\d{8}$/.test(s))  return 'EAN8';
  if(/^\d{12}$/.test(s)) return 'UPC';
  if(/^\d{14}$/.test(s)) return 'ITF14';
  return 'CODE128';
}

function renderBarcodes(){
  if(typeof JsBarcode === 'undefined') return;
  document.querySelectorAll('canvas[data-bc]').forEach(canvas => {
    const bc = canvas.getAttribute('data-bc');
    if(!bc) return;
    try {
      JsBarcode(canvas, bc, {
        format: getBarcodeFormat(bc),
        width: 2,
        height: 60,
        displayValue: true,
        font: 'monospace',
        fontSize: 12,
        textMargin: 4,
        background: '#ffffff',
        lineColor: '#000000',
        fontOptions: 'bold',
        margin: 4
      });
    } catch(e) {
      canvas.style.display = 'none';
      const span = document.createElement('span');
      span.className = 'bc-num';
      span.textContent = bc;
      canvas.parentNode.appendChild(span);
    }
  });
}

document.getElementById('inventoryTable').addEventListener('click', function(e){
  const btn = e.target.closest('.edit-btn');
  if(btn) openEditModal(btn.getAttribute('data-bc'));
});

function renderStats(){
  const total   = allData.length;
  const units   = allData.reduce((s,i) => s + (Number(i.qty)||0), 0);
  const inStock = allData.filter(i => (Number(i.qty)||0) > 0).length;
  const low     = allData.filter(i => { const q=Number(i.qty)||0; return q>0 && q<=LOW_THRESHOLD; }).length;
  document.getElementById('statTotal').textContent   = total;
  document.getElementById('statUnits').textContent   = units;
  document.getElementById('statInStock').textContent = inStock;
  document.getElementById('statLow').textContent     = low;
  renderLiveCharts();
}

let _liveChartCat = null, _liveChartItems = null;
let _liveTypeState  = { cat: 'bar', items: 'bar' };
let _liveFilterState = { cat: 'all', items: 'all' };
const _pickerSel = { catCat: null, itemsCat: null, itemsName: null };
const LIVE_COLORS = ['#00e5ff','#00ff88','#ffaa00','#ff3355','#a855f7','#f97316','#06b6d4','#84cc16','#ec4899','#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#d946ef','#0ea5e9','#22c55e'];

function setLiveChartType(which,type){_liveTypeState[which]=type;document.querySelectorAll('.lv-type-btn[data-chart="'+which+'"]').forEach(b=>b.classList.toggle('active',b.dataset.type===type));renderLiveCharts();}
function setLiveChartFilter(which,f){_liveFilterState[which]=f;document.querySelectorAll('.lv-filter-btn[data-chart="'+which+'"]').forEach(b=>b.classList.toggle('active',b.dataset.f===f));renderLiveCharts();}

function togglePicker(id){
  ['catCat','itemsCat','itemsName'].forEach(p=>{ if(p!==id) document.getElementById(p+'Panel').classList.remove('open'); });
  const panel=document.getElementById(id+'Panel');
  if(!panel.classList.contains('open')){ rebuildPickerList(id); document.getElementById(id+'Search').value=''; filterPickerList(id); document.getElementById(id+'Search').focus(); }
  panel.classList.toggle('open');
}
document.addEventListener('click',function(e){ if(!e.target.closest('.picker-wrap')) ['catCat','itemsCat','itemsName'].forEach(id=>document.getElementById(id+'Panel').classList.remove('open')); });
function escP(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/'/g,'&#39;').replace(/"/g,'&quot;');}
function rebuildPickerList(id){
  let keys;
  if(id==='itemsName') keys=[...new Set(allData.map(i=>i.product||'--'))].sort();
  else keys=[...new Set(allData.map(i=>i.category||'IT Equipment'))].sort();
  if(!_pickerSel[id]) _pickerSel[id]=new Set(keys);
  const list = document.getElementById(id+'List');
  list.innerHTML = '';
  keys.forEach((k,i) => {
    const div = document.createElement('div');
    div.className = 'picker-item';
    div.setAttribute('data-val', k);
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id+'_'+i;
    cb.checked = _pickerSel[id].has(k);
    cb.addEventListener('change', function(){ 
      if(this.checked) _pickerSel[id].add(k); else _pickerSel[id].delete(k);
      updatePickerCount(id);
    });
    const lbl = document.createElement('label');
    lbl.htmlFor = cb.id;
    lbl.title = k;
    lbl.textContent = k;
    div.appendChild(cb);
    div.appendChild(lbl);
    list.appendChild(div);
  });
  updatePickerCount(id);
}
function filterPickerList(id){const q=document.getElementById(id+'Search').value.trim().toLowerCase();document.querySelectorAll('#'+id+'List .picker-item').forEach(el=>{el.style.display=(!q||el.dataset.val.toLowerCase().includes(q))?'':'none';});}
function pickerSelectAll(id){document.querySelectorAll('#'+id+'List .picker-item').forEach(el=>{if(el.style.display!=='none'){el.querySelector('input').checked=true;pickerCbChange(id,el.dataset.val,true);}});}
function pickerClearAll(id){document.querySelectorAll('#'+id+'List .picker-item').forEach(el=>{if(el.style.display!=='none'){el.querySelector('input').checked=false;pickerCbChange(id,el.dataset.val,false);}});}
function pickerInvert(id){document.querySelectorAll('#'+id+'List .picker-item').forEach(el=>{if(el.style.display!=='none'){const cb=el.querySelector('input');cb.checked=!cb.checked;pickerCbChange(id,el.dataset.val,cb.checked);}});}
function updatePickerCount(id){document.getElementById(id+'Count').textContent=(_pickerSel[id]?_pickerSel[id].size:0)+' selected';}
function applyPicker(which,id){document.getElementById(id+'Panel').classList.remove('open');const items=document.querySelectorAll('#'+id+'List .picker-item');document.getElementById(id+'Toggle').classList.toggle('has-sel',_pickerSel[id]&&_pickerSel[id].size<items.length&&_pickerSel[id].size>0);renderLiveCharts();}

function renderLiveCharts(){
  if(typeof Chart==='undefined') return;
  const catUnits={},catItems={};
  allData.forEach(i=>{const k=i.category||'IT Equipment';catUnits[k]=(catUnits[k]||0)+(Number(i.qty)||0);catItems[k]=(catItems[k]||0)+1;});
  function applyFilter(map,filterKey,pickerId,namePickerId){
    let entries=Object.entries(map);
    const f=_liveFilterState[filterKey];
    if(f==='instock') entries=entries.filter(([k])=>(catUnits[k]||0)>0);
    else if(f==='low') entries=entries.filter(([k])=>{const u=catUnits[k]||0;return u>0&&u<=LOW_THRESHOLD;});
    else if(f==='zero') entries=entries.filter(([k])=>(catUnits[k]||0)<=0);
    entries=entries.sort((a,b)=>b[1]-a[1]);
    if(f==='top8') entries=entries.slice(0,8);
    if(pickerId&&_pickerSel[pickerId]&&_pickerSel[pickerId].size>0) entries=entries.filter(([k])=>_pickerSel[pickerId].has(k));
    if(namePickerId&&_pickerSel[namePickerId]&&_pickerSel[namePickerId].size>0){
      const sel=_pickerSel[namePickerId];const fm={};
      allData.forEach(i=>{if(!sel.has(i.product||'--'))return;const k=i.category||'IT Equipment';fm[k]=(fm[k]||0)+1;});
      entries=Object.entries(fm).sort((a,b)=>b[1]-a[1]);
    }
    return entries;
  }
  function buildChart(canvasId,chartRef,mapData,filterKey,typeKey,label,pickerId,namePickerId){
    const entries=applyFilter(mapData,filterKey,pickerId,namePickerId);
    const labels=entries.map(e=>e[0]),values=entries.map(e=>e[1]),colors=labels.map((_,i)=>LIVE_COLORS[i%LIVE_COLORS.length]);
    const type=_liveTypeState[typeKey],isPolar=type==='pie'||type==='doughnut'||type==='polarArea';
    const ctx=document.getElementById(canvasId).getContext('2d');
    if(chartRef) chartRef.destroy();
    const ds={label,data:values,backgroundColor:colors.map(c=>c+(isPolar?'bb':'55')),borderColor:colors.map(c=>c+'cc'),borderWidth:2,borderRadius:isPolar?0:4,borderSkipped:false,hoverOffset:isPolar?8:0};
    const opts={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:isPolar,position:'right',labels:{color:'#cdd9e5',font:{family:'monospace',size:9},boxWidth:12,padding:8}},tooltip:{backgroundColor:'#0e1620',borderColor:'rgba(0,229,255,0.3)',borderWidth:1,titleColor:'#00e5ff',bodyColor:'#cdd9e5',titleFont:{family:'monospace',size:11},bodyFont:{family:'monospace',size:12},callbacks:{title:i=>Array.isArray(i)?i[0].label:i.label,label:i=>' Val: '+i.raw}}}};
    if(!isPolar) opts.scales={x:{ticks:{color:'#64748b',font:{family:'monospace',size:9},maxRotation:45,minRotation:30},grid:{color:'rgba(26,48,64,0.6)'},border:{color:'#1a3040'}},y:{beginAtZero:true,ticks:{color:'#64748b',font:{family:'monospace',size:9},stepSize:1},grid:{color:'rgba(26,48,64,0.6)'},border:{color:'#1a3040'}}};
    return new Chart(ctx,{type,data:{labels,datasets:[ds]},options:opts});
  }
  _liveChartCat  =buildChart('liveChartCat', _liveChartCat, catUnits,'cat',  'cat',  'Units in Stock','catCat',  null);
  _liveChartItems=buildChart('liveChartItems',_liveChartItems,catItems,'items','items','SKUs',          'itemsCat','itemsName');
}

const CATEGORIES = [
  '3D Printer','3D Scanner','Access Control','Access Point','Adapter / Dongle','Alarm System','All-in-One PC',
  'Antenna','Antivirus License','Arduino / Microcontroller','ATS / Transfer Switch','Audio Interface',
  'Badge Reader','Barcode Scanner','Battery / CMOS','Battery Pack','Biometric Lock','Biometric Scanner',
  'Blade Server','Blanking Panel','Bluetooth Adapter','Cable','Cable Management','Capture Card',
  'Card Reader','Charger','Chromebook','Cleaning Kit','Computer','Conference Camera','Conference Phone',
  'Connector / Coupler','Cooling / Fan','Cooling Unit','CPU / Processor','Desk Phone','Desktop',
  'Digital Signage','Display Port Splitter','Docking Station','Document Scanner','Drone',
  'Embedded System','Environmental Monitor','Expansion Card','Fibre Cable','Film Scanner','Firewall',
  'Generator','GPU / Graphics','GPU/PSU','Graphics Tablet','Hard Drive','Hardware Warranty',
  'HDMI / DisplayPort Cable','Headphones','Headset','Headset Base Station','Industrial PC',
  'Ink Cartridge','Intercom / Video Doorbell','IoT Device','IP Camera','IT Equipment','Keyboard',
  'Kiosk','KVM Extender','KVM over IP','KVM Switch','Label Printer','Label Roll','Laptop',
  'Load Balancer','Media Converter','Media Player','MFP / Copier','Micro PC / NUC','Microphone',
  'Mini PC','MISC','Monitor','Motherboard','Mouse','NAS','Network Analyzer','Network Card / NIC',
  'Network Modem','Network Switch','Network Tap','Networking','NVMe Drive','NVR / DVR','Optical Drive',
  'OS License','Pager','Patch Cable','Patch Panel','PBX / Phone System','PDU','Peripheral','Phone',
  'Phone Base','PoE','Plotter','Port Replicator','POS Terminal','Power Cable','Power Strip','Power Supply','Printer',
  'Printer Drum','Projector','Proxy Appliance','Rack / Enclosure','Rack Rail Kit','Rack Shelf',
  'RAID Controller','RAM / Memory','Raspberry Pi / SBC','Receipt Printer','RFID Reader','Router',
  'Rugged Device','SAN','Satellite Equipment','Scanner','SD Card','SD-WAN Appliance',
  'Security Key / Token','Server','Server Cabinet','Set-Top Box','Signature Pad','Smart Card Reader',
  'Smart Hub','Smart TV','Smartphone','Software License','Sound Card','Soundbar','Speaker','SSD',
  'Storage Array','Streaming Device','Subscription / SaaS','Surge Protector','Tablet','Tape Drive',
  'Thermal Paper','Thin Client','Toner Cartridge','Trackpad / Trackball','Transceiver / SFP','UPS',
  'USB Cable','USB Drive','USB Hub','Video Conferencing System','Video Wall Controller','VoIP Phone',
  'VPN Concentrator','VR / AR Headset','Walkie-Talkie','Wearable','Webcam','Wi-Fi Adapter',
  'Wireless AP','Workstation'
];

let currentEditBarcode = null;

function openEditModal(barcode){
  const item = allData.find(i => i.barcode === barcode);
  if(!item){ liveToast('Item not found', 'error'); return; }
  currentEditBarcode = barcode;

  const sel = document.getElementById('editCategory');
  sel.innerHTML = '<option value="">-- Select Category --</option>'
    + CATEGORIES.map(c => '<option value="' + esc(c) + '"' + (c === item.category ? ' selected' : '') + '>' + esc(c) + '</option>').join('');

  document.getElementById('editBarcode').value  = item.barcode  || '';
  document.getElementById('editProduct').value  = item.product  || '';
  document.getElementById('editModel').value    = item.model    || '';
  document.getElementById('editQty').value      = item.qty      ?? 0;
  document.getElementById('editLocation').value = item.location || '';

  document.getElementById('editModal').classList.add('show');
  document.getElementById('editProduct').focus();
}

function closeEditModal(){
  document.getElementById('editModal').classList.remove('show');
  currentEditBarcode = null;
}

function saveEdit(){
  if(!currentEditBarcode){ liveToast('No item selected', 'error'); return; }

  const product = document.getElementById('editProduct').value.trim();
  if(!product){ liveToast('Product name is required', 'error'); return; }

  const updatedItem = {
    barcode:  currentEditBarcode,
    product,
    model:    document.getElementById('editModel').value.trim(),
    category: document.getElementById('editCategory').value || 'IT Equipment',
    qty:      Math.max(0, parseInt(document.getElementById('editQty').value) || 0),
    location: document.getElementById('editLocation').value.trim() || 'IT Office'
  };

  if(window.opener && !window.opener.closed){
    try {
      window.opener.postMessage({ type: 'itinv_edit', item: updatedItem }, '*');

      const idx = allData.findIndex(i => i.barcode === currentEditBarcode);
      if(idx !== -1) allData[idx] = updatedItem; else allData.push(updatedItem);
      renderAll();
      closeEditModal();
      liveToast('\u2713 Saved \u2014 ' + product);
    } catch(e){
      liveToast('Save failed: ' + e.message, 'error');
    }
  } else {
    liveToast('Main app window not reachable', 'error');
  }
}

document.getElementById('editModal').addEventListener('click', function(e){
  if(e.target === this) closeEditModal();
});

(function(){
  try {
    const raw = document.body.getAttribute('data-inv'); const inv = raw ? JSON.parse(raw) : {};
    allData = Object.values(inv || {});
  } catch(e){ allData = []; }
})();

setFilter('instock');
document.getElementById('searchInput').addEventListener('input', renderAll);

let _gotFirstPush=false;
(function requestWithRetry(n){
  if(_gotFirstPush||n<=0){
    if(!_gotFirstPush){
      const dot=document.getElementById('connDot'),lbl=document.getElementById('connLabel');
      if(dot){dot.style.background='#ff3355';dot.style.boxShadow='0 0 6px #ff3355';}
      if(lbl){lbl.textContent='Disconnected';lbl.style.color='#ff3355';}
    }
    return;
  }
  pullFromOpener();
  setTimeout(()=>requestWithRetry(n-1),400);
})(15);

let _refreshInterval=null;
function setRefreshInterval(ms){if(_refreshInterval)clearInterval(_refreshInterval);if(ms>0)_refreshInterval=setInterval(pullFromOpener,ms);}
document.getElementById('refreshIntervalSelect').addEventListener('change',function(){setRefreshInterval(parseInt(this.value));});
setRefreshInterval(30000);

<\/script>
</body>
</html>`;
    }

    (function checkBrowserCompatibility() {
      if (!window.showDirectoryPicker) {
        console.warn("File System Access API not supported in this browser");
        setTimeout(() => {
          showToast("‚ö† Auto-save requires Chrome, Edge, or Opera browser", "warn");
          setStatus("‚ö† Browser not compatible - auto-save disabled. Data will use browser storage only.");
        }, 1000);
      }
    })();

  </script>
</body>

</html>